<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>PROG V8.1 (Rescue)</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

  <script>
    function HARD_RESET() {
        if(confirm("ATTENTION : Ceci va vider la m√©moire locale et recharger la page. Utile si l'application est bloqu√©e. Confirmer ?")) {
            localStorage.clear();
            window.location.reload();
        }
    }
    // Affichage des erreurs √† l'√©cran pour le diagnostic
    window.onerror = function(message, source, lineno, colno, error) {
        const consoleDiv = document.getElementById('debug-console');
        if(consoleDiv) {
            consoleDiv.style.display = 'block';
            consoleDiv.innerHTML += `<div style="color:#ff6b6b; margin-bottom:4px;">ERROR: ${message} (Ligne ${lineno})</div>`;
        }
    };
  </script>

  <style>
    /* DESIGN SYSTEM V8.1 */
    :root { --bg-body: #0F172A; --bg-card: #1E293B; --bg-input: #0F172A; --text-main: #F1F5F9; --text-muted: #94A3B8; --primary: #3B82F6; --success: #10B981; --danger: #EF4444; --border-color: #334155; }
    :root.light { --bg-body: #F8FAFC; --bg-card: #FFFFFF; --bg-input: #F1F5F9; --text-main: #0F172A; --text-muted: #64748B; --border-color: #CBD5E1; }

    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
    body { background: var(--bg-body); color: var(--text-main); padding: 20px 20px 140px; font-size: 14px; max-width: 1600px; margin: 0 auto; }
    
    .btn { height: 40px; padding: 0 16px; border-radius: 8px; font-weight: 600; cursor: pointer; border: 1px solid transparent; display: inline-flex; align-items: center; justify-content: center; font-size: 13px; color: var(--text-main); }
    .btn-primary { background: var(--primary); color: white; }
    .btn-secondary { background: var(--bg-card); border-color: var(--border-color); }
    .btn-danger { background: rgba(239,68,68,0.2); color: var(--danger); border: 1px solid var(--danger); }
    
    /* Layout */
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }
    .toolbar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .card { background: var(--bg-card); padding: 15px; border-radius: 12px; border: 1px solid var(--border-color); margin-bottom: 20px; }
    
    /* Grid Stats */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
    
    /* Table */
    .table-wrap { overflow-x: auto; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-color); }
    table { width: 100%; border-collapse: collapse; min-width: 800px; }
    th { text-align: left; padding: 12px; background: var(--bg-input); color: var(--text-muted); font-size: 11px; text-transform: uppercase; }
    td { padding: 10px 12px; border-bottom: 1px solid var(--border-color); }
    tr:last-child td { border-bottom: none; }
    
    /* Inputs */
    .input { width: 100%; height: 38px; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-main); padding: 0 10px; }
    
    /* Modal - FIX: Hidden by default */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: center; justify-content: center; }
    .modal-overlay.open { display: flex; }
    .modal { background: var(--bg-card); width: 100%; max-width: 500px; padding: 20px; border-radius: 15px; border: 1px solid var(--border-color); max-height: 90vh; overflow-y: auto; }

    /* Debug Console */
    #debug-console { position: fixed; bottom: 0; right: 0; width: 100%; max-height: 150px; background: rgba(0,0,0,0.9); color: #fff; font-family: monospace; font-size: 12px; padding: 10px; overflow-y: auto; z-index: 9999; display: none; border-top: 2px solid var(--danger); }
    
    .badge { padding: 3px 8px; border-radius: 4px; font-weight: bold; font-size: 11px; display: inline-block; }
    .color-preview { display:inline-block; width:12px; height:12px; border-radius:50%; margin-right:5px; }
  </style>
</head>
<body>

  <div class="header">
    <div style="font-size:20px; font-weight:800;">PROJET V8.1</div>
    <div>
        <button class="btn btn-secondary" onclick="document.documentElement.classList.toggle('light')">Th√®me</button>
        <button class="btn btn-danger" onclick="HARD_RESET()">üõë RESET SECOURS</button>
    </div>
  </div>

  <div class="toolbar">
    <button class="btn btn-primary" onclick="App.methods.saveJson()">üíæ Sauver JSON</button>
    <button class="btn btn-secondary" onclick="App.methods.exportCsv()">CSV</button>
    <button class="btn btn-secondary" onclick="App.methods.exportPdf()">PDF</button>
    <div style="flex:1"></div>
    <button class="btn btn-secondary" onclick="App.methods.undo()" id="btn-undo">Annuler</button>
    <button class="btn btn-secondary" onclick="document.getElementById('file-input').click()">Import</button>
    <button class="btn btn-danger" onclick="App.methods.clearAll()">Effacer Tout</button>
    <input type="file" id="file-input" class="hidden" accept=".json" onchange="App.methods.importFile(this)">
  </div>

  <div class="stats-grid" id="stats-area"></div>

  <div style="margin-bottom:15px; display:flex; gap:10px">
      <input type="text" class="input" id="inp-search" placeholder="Rechercher..." oninput="App.state.search=this.value; App.render.all()">
      <button class="btn btn-success" onclick="App.ui.openModal()">+ Ajouter</button>
      <button class="btn btn-secondary" onclick="document.getElementById('modal-types').classList.add('open'); App.render.typesList();">Types</button>
  </div>
  
  <div id="main-content" class="table-wrap"></div>

  <div class="modal-overlay" id="modal-edit">
    <div class="modal">
        <h3>√âditer / Cr√©er</h3>
        <form onsubmit="event.preventDefault(); App.methods.saveItem()">
            <input type="hidden" id="f-id">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px">
                <select id="f-programme" class="input" required></select>
                <select id="f-niveau" class="input" required></select>
            </div>
            <select id="f-fonction" class="input" style="margin-bottom:10px"></select>
            <input type="text" id="f-local" class="input" placeholder="Nom du local" required style="margin-bottom:10px">
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-bottom:10px">
                <input type="number" id="f-surf" class="input" placeholder="S.U." step="0.01">
                <input type="number" id="f-nbr" class="input" value="1">
                <label style="display:flex;align-items:center"><input type="checkbox" id="f-isExt"> Ext?</label>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px">
                <select id="f-statut" class="input"></select>
                <select id="f-priorite" class="input"></select>
            </div>
            <div style="display:flex; justify-content:space-between; margin-top:20px">
                <button type="button" class="btn btn-danger" onclick="App.methods.deleteItem()">Supprimer</button>
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('modal-edit').classList.remove('open')">Fermer</button>
                <button type="submit" class="btn btn-primary">Enregistrer</button>
            </div>
        </form>
    </div>
  </div>

  <div class="modal-overlay" id="modal-types">
      <div class="modal">
          <h3>Configuration Types</h3>
          <select id="type-cat" class="input" onchange="App.render.typesList()" style="margin-bottom:10px">
              <option value="programmes">Programmes</option>
              <option value="niveaux">Niveaux</option>
              <option value="fonctions">Fonctions</option>
              <option value="statuts">Statuts</option>
              <option value="priorites">Priorit√©s</option>
          </select>
          <div id="types-list" style="max-height:300px; overflow-y:auto; border:1px solid var(--border-color); margin-bottom:10px; padding:5px;"></div>
          <div style="display:flex; gap:5px">
              <input type="text" id="new-type-name" class="input" placeholder="Nom...">
              <input type="color" id="new-type-bg" value="#333333" style="height:38px; width:40px">
              <button class="btn btn-success" onclick="App.methods.addType()">+</button>
          </div>
          <button class="btn btn-secondary" style="width:100%; margin-top:10px" onclick="document.getElementById('modal-types').classList.remove('open'); App.render.all()">Fermer</button>
      </div>
  </div>

  <div id="debug-console"><b>CONSOLE DE D√âBOGAGE (Si vide, tout va bien)</b><br></div>

  <script>
    // --- MAIN LOGIC ---
    const DEFAULT_TYPES = {
        programmes: [{id:1,nom:"BUREAUX",bg:"#3B82F6",txt:"#FFF"},{id:2,nom:"LOGEMENTS",bg:"#10B981",txt:"#FFF"}],
        niveaux: [{id:1,nom:"RDC",bg:"#64748B",txt:"#FFF"},{id:2,nom:"R+1",bg:"#94A3B8",txt:"#FFF"}],
        fonctions: [{id:1,nom:"Travail",bg:"#E2E8F0",txt:"#334155"}],
        statuts: [{id:1,nom:"VALID√â",bg:"#10B981",txt:"#FFF"},{id:2,nom:"√Ä CONFIRMER",bg:"#F59E0B",txt:"#FFF"}],
        priorites: [{id:1,nom:"HAUTE",bg:"#EF4444",txt:"#FFF"},{id:2,nom:"BASSE",bg:"#10B981",txt:"#FFF"}]
    };

    const App = {
        state: {
            data: [],
            types: JSON.parse(JSON.stringify(DEFAULT_TYPES)),
            search: ""
        },
        
        init: () => {
            try {
                // Chargement des donn√©es avec blindage
                const d = localStorage.getItem('v8-data');
                const t = localStorage.getItem('v8-types');
                if(d) App.state.data = JSON.parse(d);
                if(t) App.state.types = JSON.parse(t);
                
                // V√©rification int√©grit√© des types
                for(let k in DEFAULT_TYPES) {
                    if(!App.state.types[k] || !Array.isArray(App.state.types[k])) {
                        App.state.types[k] = JSON.parse(JSON.stringify(DEFAULT_TYPES[k]));
                    }
                }
                
                App.render.all();
                console.log("App initialized successfully");
            } catch(e) {
                console.error("Init Error", e);
                document.getElementById('debug-console').style.display='block';
                document.getElementById('debug-console').innerHTML += `INIT ERROR: ${e.message}<br>`;
            }
        },

        methods: {
            save: () => {
                localStorage.setItem('v8-data', JSON.stringify(App.state.data));
                localStorage.setItem('v8-types', JSON.stringify(App.state.types));
            },
            saveJson: () => {
                const blob = new Blob([JSON.stringify(App.state, null, 2)], {type:'application/json'});
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); 
                a.download = `PROJET-${new Date().toISOString().slice(0,10)}.json`; a.click();
            },
            importFile: (input) => {
                const f = input.files[0];
                if(!f) return;
                const r = new FileReader();
                r.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        if(json.data) App.state.data = json.data;
                        if(json.types) App.state.types = json.types;
                        // Support pour les anciens formats si "data" est directement un tableau
                        if(Array.isArray(json)) App.state.data = json; 
                        App.methods.save();
                        App.render.all();
                        alert("Import r√©ussi !");
                    } catch(err) { alert("Erreur fichier JSON"); }
                };
                r.readAsText(f);
            },
            clearAll: () => {
                if(confirm("Tout effacer ?")) {
                    App.state.data = [];
                    App.methods.save();
                    App.render.all();
                }
            },
            saveItem: () => {
                const id = document.getElementById('f-id').value;
                const item = {
                    id: id ? parseInt(id) : Date.now(),
                    programme: document.getElementById('f-programme').value,
                    niveau: document.getElementById('f-niveau').value,
                    fonction: document.getElementById('f-fonction').value,
                    local: document.getElementById('f-local').value,
                    surfUnite: parseFloat(document.getElementById('f-surf').value)||0,
                    nombre: parseFloat(document.getElementById('f-nbr').value)||1,
                    isExt: document.getElementById('f-isExt').checked,
                    statut: document.getElementById('f-statut').value,
                    priorite: document.getElementById('f-priorite').value
                };
                // Calcul surfaces
                const tot = item.surfUnite * item.nombre;
                item.sueInt = item.isExt ? 0 : tot;
                item.sueExt = item.isExt ? tot : 0;

                if(id) {
                    const idx = App.state.data.findIndex(i=>i.id == id);
                    if(idx > -1) App.state.data[idx] = item;
                } else {
                    App.state.data.push(item);
                }
                App.methods.save();
                document.getElementById('modal-edit').classList.remove('open');
                App.render.all();
            },
            deleteItem: () => {
                const id = document.getElementById('f-id').value;
                if(id && confirm("Supprimer ?")) {
                    App.state.data = App.state.data.filter(i=>i.id != id);
                    App.methods.save();
                    document.getElementById('modal-edit').classList.remove('open');
                    App.render.all();
                }
            },
            // TYPES MANAGEMENT
            addType: () => {
                const cat = document.getElementById('type-cat').value;
                const nom = document.getElementById('new-type-name').value;
                const bg = document.getElementById('new-type-bg').value;
                if(nom) {
                    App.state.types[cat].push({id:Date.now(), nom, bg, txt:"#FFFFFF"});
                    App.methods.save();
                    App.render.typesList();
                }
            },
            delType: (cat, id) => {
                App.state.types[cat] = App.state.types[cat].filter(t=>t.id!==id);
                App.methods.save();
                App.render.typesList();
            },
            exportCsv: () => {
                const rows = App.state.data.map(d=>[d.programme,d.niveau,d.fonction,d.local,d.surfUnite,d.nombre].join(';'));
                const blob = new Blob(["Prog;Niv;Fct;Local;SU;Nb\n"+rows.join('\n')],{type:'text/csv'});
                const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download="export.csv"; a.click();
            },
            exportPdf: () => {
               if(!window.jspdf) { alert("Erreur librairie PDF"); return; }
               const doc = new window.jspdf.jsPDF();
               const rows = App.state.data.map(d=>[d.programme,d.niveau,d.local,String(d.surfUnite),String(d.nombre)]);
               doc.autoTable({head:[['Prog','Niv','Local','SU','Nb']], body:rows});
               doc.save('projet.pdf');
            }
        },

        ui: {
            openModal: (item) => {
                // Populate selects
                ['programme','niveau','fonction','statut','priorite'].forEach(k => {
                    const sel = document.getElementById('f-'+k);
                    sel.innerHTML = '<option value="">-</option>' + (App.state.types[k+'s']||[]).map(t=>`<option value="${t.nom}">${t.nom}</option>`).join('');
                });
                
                const f = (id) => document.getElementById(id);
                if(item) {
                    f('f-id').value=item.id; f('f-programme').value=item.programme; f('f-niveau').value=item.niveau;
                    f('f-fonction').value=item.fonction; f('f-local').value=item.local; f('f-surf').value=item.surfUnite;
                    f('f-nbr').value=item.nombre; f('f-isExt').checked=item.isExt; f('f-statut').value=item.statut; f('f-priorite').value=item.priorite;
                } else {
                    document.getElementById('form-item').reset();
                    f('f-id').value="";
                }
                document.getElementById('modal-edit').classList.add('open');
            }
        },

        render: {
            all: () => {
                // Stats
                const tot = App.state.data.reduce((acc, i) => acc + (i.sueInt||0) + (i.sueExt||0), 0);
                document.getElementById('stats-area').innerHTML = `
                    <div class="card" style="text-align:center"><b>TOTAL</b><br><span style="font-size:20px;color:var(--primary)">${tot} m¬≤</span></div>
                    <div class="card" style="text-align:center"><b>LOCAUX</b><br><span style="font-size:20px">${App.state.data.length}</span></div>
                `;

                // Table
                const tbody = App.state.data
                    .filter(i => !App.state.search || i.local.toLowerCase().includes(App.state.search.toLowerCase()))
                    .map(i => {
                        const prog = (App.state.types.programmes||[]).find(p=>p.nom===i.programme) || {bg:'#555',txt:'#fff'};
                        return `<tr onclick='App.ui.openModal(${JSON.stringify(i)})' style="cursor:pointer; hover:background:var(--bg-hover)">
                            <td><span class="badge" style="background:${prog.bg};color:${prog.txt}">${i.programme}</span></td>
                            <td>${i.niveau}</td>
                            <td><b>${i.local}</b></td>
                            <td>${i.surfUnite}</td>
                            <td>${i.nombre}</td>
                            <td><b>${(i.sueInt||0)+(i.sueExt||0)}</b></td>
                        </tr>`;
                    }).join('');
                document.getElementById('main-content').innerHTML = `<table>
                    <thead><tr><th>Prog</th><th>Niv</th><th>Local</th><th>SU</th><th>Nb</th><th>Tot</th></tr></thead>
                    <tbody>${tbody||'<tr><td colspan="6" style="text-align:center;padding:20px">Aucune donn√©e</td></tr>'}</tbody>
                </table>`;
            },
            typesList: () => {
                const cat = document.getElementById('type-cat').value;
                const list = App.state.types[cat] || [];
                document.getElementById('types-list').innerHTML = list.map(t => `
                    <div style="display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid #444">
                        <div style="display:flex; align-items:center">
                            <span class="color-preview" style="background:${t.bg}"></span> ${t.nom}
                        </div>
                        <button class="btn btn-danger" style="padding:2px 6px; font-size:10px" onclick="App.methods.delType('${cat}', ${t.id})">X</button>
                    </div>
                `).join('');
            }
        }
    };

    // D√©marrage
    window.onload = App.init;
  </script>
</body>
</html>
