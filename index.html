<!DOCTYPE html>
<html lang="fr"><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>APP FRAMEWORK V8 - GRAPH</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
  
  <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

  <style>
    /* --- CORE CSS --- */
    :root { --bg: #0F172A; --card: #1E293B; --input: #0F172A; --text: #F1F5F9; --muted: #94A3B8; --primary: #3B82F6; --success: #10B981; --danger: #EF4444; --accent: #8B5CF6; --border: #334155; }
    :root.light { --bg: #F8FAFC; --card: #FFFFFF; --input: #F1F5F9; --text: #0F172A; --muted: #64748B; --primary: #2563EB; --border: #CBD5E1; }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
    body { background: var(--bg); color: var(--text); padding: 20px; font-size: 14px; padding-bottom: 100px; max-width: 1600px; margin: 0 auto; transition: 0.3s; height: 100vh; display: flex; flex-direction: column; }
    
    /* Layout */
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 20px; flex-shrink: 0; }
    .app-title { font-size: 24px; font-weight: 800; }
    .toolbar { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; align-items: center; flex-shrink: 0; }
    
    /* Components */
    .btn { height: 40px; padding: 0 16px; border-radius: 8px; border: 1px solid var(--border); cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; background: var(--card); color: var(--text); transition: 0.2s; }
    .btn:hover { background: var(--border); }
    .btn-primary { background: var(--primary); color: white; border: none; }
    .btn-danger { color: var(--danger); background: rgba(239,68,68,0.1); border-color: rgba(239,68,68,0.3); }
    .btn-xs { height: 28px; padding: 0 10px; font-size: 12px; }
    
    /* Views */
    .view-container { flex: 1; overflow: hidden; display: none; }
    .view-container.active { display: block; }
    
    /* Table */
    .table-scroll { height: 100%; overflow: auto; background: var(--card); border-radius: 12px; border: 1px solid var(--border); }
    table { width: 100%; border-collapse: collapse; white-space: nowrap; }
    th { text-align: left; padding: 14px 12px; background: var(--input); color: var(--muted); font-size: 11px; text-transform: uppercase; position: sticky; top: 0; z-index: 10; }
    td { padding: 12px; border-bottom: 1px solid var(--border); }
    tr:hover td { background: var(--bg); }

    /* Graph View */
    #mynetwork { width: 100%; height: 100%; background: var(--card); border-radius: 12px; border: 1px solid var(--border); }

    /* Modals */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(4px); }
    .modal { background: var(--card); padding: 30px; border-radius: 16px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; border: 1px solid var(--border); display: flex; flex-direction: column; }
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 12px; font-weight: 700; color: var(--muted); margin-bottom: 6px; text-transform: uppercase; }
    .form-control { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--input); color: var(--text); }
    
    /* Relations Specific */
    .rel-item { display: flex; align-items: center; justify-content: space-between; padding: 8px; background: var(--input); margin-bottom: 8px; border-radius: 8px; border: 1px solid var(--border); }
    .rel-weight { font-size: 11px; font-weight: bold; color: var(--accent); margin-right: 10px; }
    
    .badge { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; }
    .highlight { background: rgba(253, 224, 71, 0.3); color: var(--text); padding: 0 2px; border-radius: 2px; }
    .hidden { display: none; }
  </style>
</head>
<body>

<script>
// üü¢ CONFIGURATION
const APP_DEF = {
    title: "PROGRAMME & ORGANIGRAMME",
    storageKey: "coffim-app-v8",
    lists: {
        niveaux: [ {id:1, nom:"RDC"}, {id:2, nom:"R+1"}, {id:3, nom:"R+2"} ],
        fonctions: [ {id:1, nom:"Public"}, {id:2, nom:"Personnel"}, {id:3, nom:"Logistique"} ],
        weights: [ {val: 1, label: "Proximit√© (Faible)"}, {val: 3, label: "Adjacence (Moyenne)"}, {val: 6, label: "Connexion Directe (Forte)"} ]
    },
    fields: [
        { key: 'niveau',    label: 'Niveau',    type: 'select', list: 'niveaux',    width: '80px',  badge: true },
        { key: 'fonction',  label: 'Fonction',  type: 'select', list: 'fonctions',  width: '100px', badge: true },
        { key: 'local',     label: 'Local',     type: 'text',   width: '200px',     main: true,     required: true },
        { key: 'surfUnite', label: 'S.U.',      type: 'number', width: '80px',      align: 'right', summary: 'sum' },
        // Champ cach√© pour stocker les relations
        { key: 'relations', label: 'Liens',     type: 'json',   hidden: true,       default: [] }
    ],
    hooks: {
        getColor: (str) => {
            const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6'];
            let hash = 0; for (let i=0; i<str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            return colors[Math.abs(hash) % colors.length];
        }
    }
};
</script>

<div id="app" style="height: 100%; display: flex; flex-direction: column;">
    </div>

<script>
let data = [];
let lists = JSON.parse(JSON.stringify(APP_DEF.lists));
let currentView = 'list'; // 'list' ou 'graph'
let network = null; // Vis.js instance

function init() {
    const savedData = localStorage.getItem(APP_DEF.storageKey + '_data');
    if (savedData) data = JSON.parse(savedData);
    renderLayout();
}

function renderLayout() {
    const app = document.getElementById('app');
    app.innerHTML = `
        <div class="header">
            <div class="app-title">${APP_DEF.title}</div>
            <div style="display:flex; gap:10px">
                <button class="btn ${currentView==='list'?'btn-primary':''}" onclick="switchView('list')">üìã Liste</button>
                <button class="btn ${currentView==='graph'?'btn-primary':''}" onclick="switchView('graph')">üï∏Ô∏è Graphique</button>
                <button class="btn" onclick="toggleTheme()">üåó</button>
            </div>
        </div>

        <div id="view-list" class="view-container ${currentView==='list'?'active':''}">
            <div class="toolbar">
                <button class="btn btn-primary" onclick="openEditModal()">‚ûï Nouveau Local</button>
                <button class="btn" onclick="exportCSV()">üìÑ Export CSV</button>
            </div>
            <div class="table-scroll">
                <table>
                    <thead>
                        <tr>
                            ${APP_DEF.fields.filter(f => !f.hidden).map(f => `<th style="width:${f.width}; text-align:${f.align||'left'}">${f.label}</th>`).join('')}
                            <th style="width:120px; text-align:right">Relations</th>
                            <th style="width:50px">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(row => {
                            const linkCount = (row.relations || []).length;
                            return `
                            <tr>
                                ${APP_DEF.fields.filter(f => !f.hidden).map(f => {
                                    let val = row[f.key] || '-';
                                    let style = f.align ? `text-align:${f.align}` : '';
                                    if(f.badge && row[f.key]) {
                                        const color = APP_DEF.hooks.getColor(row[f.key]);
                                        val = `<span class="badge" style="background:${color}20; color:${color}">${val}</span>`;
                                    }
                                    return `<td style="${style}">${val}</td>`;
                                }).join('')}
                                <td style="text-align:right">
                                    <button class="btn btn-xs" onclick="openRelationsModal(${row.id})" title="G√©rer les liens">
                                        üîó ${linkCount > 0 ? linkCount : '+'}
                                    </button>
                                </td>
                                <td>
                                    <button class="btn btn-xs btn-danger" onclick="deleteItem(${row.id})">√ó</button>
                                    <button class="btn btn-xs" onclick="openEditModal(${row.id})">‚úé</button>
                                </td>
                            </tr>`;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        </div>

        <div id="view-graph" class="view-container ${currentView==='graph'?'active':''}">
            <div id="mynetwork"></div>
            <div style="position:absolute; bottom:20px; left:20px; background:var(--card); padding:10px; border-radius:8px; border:1px solid var(--border); font-size:12px">
                ‚ÑπÔ∏è Double-cliquez sur un n≈ìud pour √©diter.<br>
                Utilisez la molette pour zoomer.
            </div>
        </div>
    `;
    
    if(currentView === 'graph') drawGraph();
}

function switchView(view) {
    currentView = view;
    renderLayout();
}

// --- MODAL EDITION CLASSIQUE ---
function openEditModal(id = null) {
    const item = id ? data.find(d => d.id === id) : {};
    
    const inputs = APP_DEF.fields.filter(f => !f.hidden).map(f => {
        let val = item[f.key] !== undefined ? item[f.key] : '';
        if (f.type === 'select') {
            const opts = (lists[f.list]||[]).map(o => `<option value="${o.nom}" ${val===o.nom?'selected':''}>${o.nom}</option>`).join('');
            return `<div class="form-group"><label class="form-label">${f.label}</label><select id="inp-${f.key}" class="form-control"><option value="">-</option>${opts}</select></div>`;
        }
        return `<div class="form-group"><label class="form-label">${f.label}</label><input type="${f.type}" id="inp-${f.key}" class="form-control" value="${val}"></div>`;
    }).join('');

    showModal("√âditer Local", inputs, () => {
        const newItem = id ? data.find(d => d.id === id) : { id: Date.now(), relations: [] };
        APP_DEF.fields.filter(f => !f.hidden).forEach(f => {
            newItem[f.key] = document.getElementById(`inp-${f.key}`).value;
        });
        if(!id) data.push(newItem);
        saveAndRefresh();
    });
}

// --- MODAL RELATIONS (Le c≈ìur du sujet) ---
function openRelationsModal(id) {
    const sourceItem = data.find(d => d.id === id);
    if(!sourceItem.relations) sourceItem.relations = [];

    const renderRelList = () => {
        if(sourceItem.relations.length === 0) return '<div style="color:var(--muted); font-style:italic; padding:10px">Aucune relation d√©finie.</div>';
        return sourceItem.relations.map((rel, idx) => {
            const target = data.find(d => d.id === rel.targetId);
            const wLabel = APP_DEF.lists.weights.find(w => w.val == rel.weight)?.label || rel.weight;
            if(!target) return ''; // Nettoyage si cible supprim√©e
            return `
            <div class="rel-item">
                <div>
                    <span class="rel-weight">‚ö° ${wLabel}</span>
                    <span>${target.local}</span>
                </div>
                <button class="btn btn-xs btn-danger" onclick="removeRelation(${id}, ${idx})">√ó</button>
            </div>`;
        }).join('');
    };

    const modalContent = `
        <div style="flex:1; overflow:auto; margin-bottom:20px" id="rel-list-container">
            ${renderRelList()}
        </div>
        <div style="border-top:1px solid var(--border); padding-top:20px; display:grid; grid-template-columns: 2fr 2fr 1fr; gap:10px; align-items:end;">
            <div class="form-group" style="margin:0">
                <label class="form-label">Lier avec...</label>
                <select id="new-rel-target" class="form-control">
                    <option value="">Choisir un local...</option>
                    ${data.filter(d => d.id !== id).map(d => `<option value="${d.id}">${d.local} (${d.niveau})</option>`).join('')}
                </select>
            </div>
            <div class="form-group" style="margin:0">
                <label class="form-label">Importance</label>
                <select id="new-rel-weight" class="form-control">
                    ${APP_DEF.lists.weights.map(w => `<option value="${w.val}">${w.label}</option>`).join('')}
                </select>
            </div>
            <button class="btn btn-primary" onclick="addRelation(${id})">Ajouter</button>
        </div>
    `;

    // Hack pour rendre les fonctions accessibles globalement pour le HTML string
    window.addRelation = (sourceId) => {
        const targetId = parseInt(document.getElementById('new-rel-target').value);
        const weight = parseInt(document.getElementById('new-rel-weight').value);
        if(!targetId) return;
        
        const item = data.find(d => d.id === sourceId);
        // √âviter doublons
        if(!item.relations.find(r => r.targetId === targetId)) {
            item.relations.push({ targetId, weight });
            saveData();
            document.getElementById('rel-list-container').innerHTML = renderRelList(); // Refresh local
        }
    };

    window.removeRelation = (sourceId, idx) => {
        const item = data.find(d => d.id === sourceId);
        item.relations.splice(idx, 1);
        saveData();
        document.getElementById('rel-list-container').innerHTML = renderRelList();
    };

    showModal(`Relations pour : ${sourceItem.local}`, modalContent, null, true); // true = hide footer buttons
}

// --- VIS.JS GRAPH ENGINE ---
function drawGraph() {
    const container = document.getElementById('mynetwork');
    const nodes = new vis.DataSet(data.map(d => ({
        id: d.id,
        label: d.local + (d.surfUnite ? `\n(${d.surfUnite}m¬≤)` : ''),
        group: d.fonction || 'Autre',
        value: parseFloat(d.surfUnite) || 10, // Taille du n≈ìud selon surface
        title: `Niveau: ${d.niveau}`
    })));

    const edgesArr = [];
    data.forEach(source => {
        if(source.relations) {
            source.relations.forEach(rel => {
                // On v√©rifie que la cible existe encore
                if(data.find(d => d.id === rel.targetId)) {
                    edgesArr.push({
                        from: source.id,
                        to: rel.targetId,
                        width: rel.weight, // √âpaisseur du trait
                        length: 300 / rel.weight, // Plus c'est fort, plus c'est court
                        color: { color: 'var(--muted)', opacity: 0.6 }
                    });
                }
            });
        }
    });
    const edges = new vis.DataSet(edgesArr);

    const options = {
        nodes: {
            shape: 'dot',
            font: { color: getComputedStyle(document.body).getPropertyValue('--text') },
            scaling: { min: 10, max: 30 }
        },
        physics: {
            forceAtlas2Based: {
                gravitationalConstant: -50,
                centralGravity: 0.01,
                springConstant: 0.08,
                springLength: 100,
                damping: 0.4,
                avoidOverlap: 0.5
            },
            solver: 'forceAtlas2Based',
            stabilization: { iterations: 150 }
        },
        groups: {
            // Auto-colors based on group names (fonctions)
            useDefaultGroups: true 
        }
    };

    network = new vis.Network(container, { nodes, edges }, options);
    
    network.on("doubleClick", function (params) {
        if (params.nodes.length === 1) {
            openRelationsModal(params.nodes[0]);
        }
    });
}

// --- SYSTEM UTILS ---
function showModal(title, content, onSave, hideFooter = false) {
    const existing = document.getElementById('active-modal');
    if(existing) existing.remove();

    const html = `
    <div class="modal-overlay" id="active-modal" onclick="if(event.target===this) this.remove()">
        <div class="modal">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
                <h2 style="font-size:18px; margin:0">${title}</h2>
                <button class="btn btn-xs" onclick="document.getElementById('active-modal').remove()">‚úï</button>
            </div>
            <div style="flex:1; overflow:auto;">${content}</div>
            ${!hideFooter ? `
            <div style="margin-top:20px; display:flex; justify-content:flex-end; gap:10px">
                <button class="btn" onclick="document.getElementById('active-modal').remove()">Annuler</button>
                <button class="btn btn-primary" id="modal-save-btn">Enregistrer</button>
            </div>` : ''}
        </div>
    </div>`;
    document.body.insertAdjacentHTML('beforeend', html);
    
    if(onSave) {
        document.getElementById('modal-save-btn').onclick = () => {
            onSave();
            document.getElementById('active-modal').remove();
        };
    }
}

function saveData() { localStorage.setItem(APP_DEF.storageKey+'_data', JSON.stringify(data)); }
function saveAndRefresh() { saveData(); renderLayout(); }
function deleteItem(id) {
    if(confirm("Supprimer ?")) {
        data = data.filter(d => d.id !== id);
        // Nettoyer les relations orphelines
        data.forEach(d => {
            if(d.relations) d.relations = d.relations.filter(r => r.targetId !== id);
        });
        saveAndRefresh();
    }
}
function toggleTheme() { document.documentElement.classList.toggle('light'); if(network) drawGraph(); }
function exportCSV() { alert("Export CSV simplifi√© pour d√©mo."); }

// BOOT
init();
</script>
</body></html>
