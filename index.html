<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="PROJET">
  <meta name="theme-color" content="#0F172A">
  <link rel="manifest" href="manifest.json">
  <title>PROGRAMMATION V7.8</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* --- DESIGN SYSTEM V7.8 --- */
    :root {
      --bg-body: #0F172A; --bg-card: #1E293B; --bg-input: #0F172A;
      --bg-hover: #334155; --border-color: #334155;
      --text-main: #F1F5F9; --text-muted: #94A3B8; --text-inv: #0F172A;
      --primary: #3B82F6; --success: #10B981; --danger: #EF4444; --warning: #F59E0B; --accent: #8B5CF6;
      --radius: 12px;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    :root.light {
      --bg-body: #F8FAFC; --bg-card: #FFFFFF; --bg-input: #F1F5F9;
      --bg-hover: #E2E8F0; --border-color: #CBD5E1;
      --text-main: #0F172A; --text-muted: #64748B; --text-inv: #FFFFFF;
      --primary: #2563EB;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
    body { background: var(--bg-body); color: var(--text-main); padding: 20px; padding-bottom: 140px; font-size: 14px; max-width: 1600px; margin: 0 auto; transition: background 0.3s; }
    
    /* UTILS */
    .hidden { display: none !important; }
    .flex { display: flex; align-items: center; gap: 10px; }
    .btn { height: 40px; padding: 0 16px; border-radius: 8px; font-weight: 600; cursor: pointer; border: 1px solid transparent; display: inline-flex; align-items: center; justify-content: center; gap: 6px; font-size: 13px; transition: all 0.2s; white-space: nowrap; }
    .btn:active { transform: scale(0.98); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; filter: grayscale(1); }
    
    .btn-primary { background: var(--primary); color: white; }
    .btn-secondary { background: var(--bg-card); border-color: var(--border-color); color: var(--text-main); }
    .btn-secondary:hover { background: var(--bg-hover); }
    .btn-accent { background: rgba(139, 92, 246, 0.15); color: var(--accent); border: 1px solid var(--accent); }
    .btn-accent:hover { background: var(--accent); color: white; }
    .btn-danger { background: rgba(239,68,68,0.1); color: var(--danger); border-color: transparent; }
    .btn-icon { width: 40px; padding: 0; font-size: 18px; }
    .btn-lock { width: 40px; padding: 0; font-size: 18px; background: var(--bg-input); border: 1px solid var(--border-color); color: var(--text-muted); }
    .btn-lock.locked { background: rgba(239,68,68,0.1); color: var(--danger); border-color: var(--danger); }

    /* LAYOUT & HEADER */
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color); }
    .header-title { font-size: 24px; font-weight: 800; border: 1px dashed transparent; padding: 0 5px; border-radius: 6px; }
    .header-title:hover { border-color: var(--border-color); }
    
    /* SAVE INDICATOR (NEW V7.8) */
    .save-indicator { font-size: 11px; color: var(--success); font-weight: 700; opacity: 0; transition: opacity 0.5s; display: inline-flex; align-items: center; gap: 4px; background: rgba(16, 185, 129, 0.1); padding: 2px 8px; border-radius: 4px; margin-left: 10px; }
    .save-indicator.show { opacity: 1; }

    .toolbar { display: flex; gap: 16px; margin-bottom: 30px; flex-wrap: wrap; align-items: center; }
    .tool-group { display: flex; align-items: center; gap: 8px; background: var(--bg-card); padding: 4px 8px; border-radius: 12px; border: 1px solid var(--border-color); }
    .spacer { flex: 1; }

    /* STATS */
    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 30px; }
    @media(max-width: 1100px) { .stats-grid { grid-template-columns: 1fr 1fr; } }
    @media(max-width: 600px) { .stats-grid { grid-template-columns: 1fr; } }
    .card { background: var(--bg-card); padding: 20px; border-radius: var(--radius); border: 1px solid var(--border-color); box-shadow: var(--shadow); position: relative; overflow: hidden; }
    .chart-row { display: flex; gap: 16px; align-items: center; height: 100%; }
    .donut { width: 70px; height: 70px; border-radius: 50%; position: relative; flex-shrink: 0; }
    .donut::after { content: ''; position: absolute; inset: 15%; background: var(--bg-card); border-radius: 50%; }
    .legend { flex: 1; display: flex; flex-direction: column; gap: 4px; font-size: 11px; }
    .legend-item { display: flex; justify-content: space-between; align-items: center; }
    .dot { width: 8px; height: 8px; border-radius: 2px; display: inline-block; margin-right: 6px; }

    /* SEGMENTED CONTROL */
    .segmented-control { display: inline-flex; background: var(--bg-card); padding: 4px; border-radius: 12px; border: 1px solid var(--border-color); margin-bottom: 20px; }
    .seg-btn { padding: 8px 24px; border-radius: 8px; font-weight: 600; font-size: 13px; cursor: pointer; color: var(--text-muted); transition: all 0.2s; border: none; background: transparent; }
    .seg-btn:hover { color: var(--text-main); }
    .seg-btn.active { background: var(--bg-hover); color: var(--text-main); shadow: var(--shadow-sm); }

    /* FILTERS */
    .filters-box { background: var(--bg-card); padding: 20px; border-radius: var(--radius); border: 1px solid var(--border-color); margin-bottom: 24px; }
    .search-row { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 12px; margin-bottom: 16px; }
    .input { width: 100%; height: 42px; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 8px; padding: 0 12px; color: var(--text-main); font-size: 14px; }
    .input:focus { outline: none; border-color: var(--primary); }
    
    .ms-container { position: relative; width: 100%; }
    .ms-btn { width: 100%; height: 42px; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 8px; padding: 0 12px; color: var(--text-main); display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none; font-size: 14px;}
    .ms-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; margin-top: 6px; max-height: 300px; overflow-y: auto; z-index: 50; padding: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: none; }
    .ms-dropdown.show { display: block; }
    .ms-option { display: flex; align-items: center; gap: 10px; padding: 8px 10px; border-radius: 6px; cursor: pointer; font-size: 13px; transition: background 0.1s; }
    .ms-option:hover { background: var(--bg-hover); }
    .ms-checkbox { pointer-events: none; accent-color: var(--primary); width: 16px; height: 16px; }

    .chip-container { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .chip { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; cursor: pointer; border: 1px solid var(--border-color); background: var(--bg-card); color: var(--text-muted); display:flex; align-items:center; gap:6px; }
    .chip.active { color: white; border-color: transparent; }
    .view-chip { border-color: var(--accent); color: var(--accent); background: rgba(139, 92, 246, 0.05); }
    .view-chip:hover { background: var(--accent); color: white; }
    .chip-del { width: 16px; height: 16px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; background: rgba(0,0,0,0.2); }

    /* TABLE */
    .table-wrap { background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border-color); overflow-x: auto; max-height: 75vh; }
    table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 900px; }
    thead { position: sticky; top: 0; z-index: 20; }
    th { background: var(--bg-input); padding: 14px 12px; text-align: left; font-size: 11px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; cursor: pointer; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
    th:hover { color: var(--text-main); background: var(--bg-hover); }
    td { padding: 12px; border-bottom: 1px solid var(--border-color); vertical-align: middle; transition: background 0.1s; }
    tbody tr:hover { background: var(--bg-hover) !important; cursor: pointer; }
    tbody tr:last-child td { border-bottom: none; }

    .badge { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; white-space: nowrap; display: inline-block; border: 1px solid transparent; }
    
    /* ACTIONS GRID */
    .actions-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 16px; }
    .action-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px; border-left: 4px solid var(--text-muted); transition: transform 0.2s; cursor: pointer; display: flex; flex-direction: column; }
    .action-card:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
    .ac-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .ac-body { font-size: 14px; font-weight: 500; margin-bottom: 12px; line-height: 1.5; flex: 1; }
    .ac-footer { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border-color); padding-top: 8px; font-size: 12px; color: var(--text-muted); margin-top: auto; }

    /* BATCH BAR */
    .batch-bar { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(150%); background: var(--bg-card); border: 1px solid var(--primary); padding: 12px 24px; border-radius: 100px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 16px; z-index: 100; transition: transform 0.3s; color: var(--text-main); }
    .batch-bar.visible { transform: translateX(-50%) translateY(0); }
    
    /* MODAL */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); z-index: 2000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
    .modal-overlay.open { opacity: 1; pointer-events: auto; }
    .modal { background: var(--bg-card); width: 100%; max-width: 500px; border-radius: 20px; padding: 24px; box-shadow: 0 25px 50px rgba(0,0,0,0.5); border: 1px solid var(--border-color); transform: translateY(20px); transition: transform 0.2s; max-height: 90vh; overflow-y: auto;}
    .modal-overlay.open .modal { transform: translateY(0); }

    /* SETTINGS STYLES */
    .settings-list-item { display:flex; justify-content:space-between; align-items:center; padding:12px; border-bottom:1px solid var(--border-color); background: var(--bg-card); transition: background 0.1s; }
    .settings-list-item:hover { background: var(--bg-hover); }
    .btn-action-sm { height: 28px; width:28px; padding: 0; font-size: 12px; border-radius: 6px; display: inline-flex; align-items: center; justify-content: center; border: 1px solid var(--border-color); background: var(--bg-input); color: var(--text-muted); cursor:pointer; margin-left:4px;}
    .btn-action-sm:hover { background: var(--bg-hover); color: var(--text-main); }
    .badge-preview { font-size: 11px; font-weight: 700; padding: 4px 8px; border-radius: 4px; }
    
    .color-picker-mini { width: 30px; height: 30px; border:none; background:none; cursor:pointer; padding:0; border-radius:4px; }
    .color-picker-wrap { width: 40px; height: 40px; border-radius: 8px; overflow: hidden; border: 1px solid var(--border-color); padding: 0; position: relative; }
    .color-picker-wrap input[type=color] { position: absolute; inset: -5px; width: 50px; height: 50px; cursor: pointer; }

    .text-right { text-align: right; }
    .text-center { text-align: center; }
  </style>
</head>
<body>

  <div class="header">
    <div class="flex">
      <div class="logo" style="width:40px;height:40px;background:linear-gradient(135deg,var(--primary),#8B5CF6);border-radius:10px;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;">B</div>
      <div>
        <div class="flex">
            <div id="app-title" class="header-title" contenteditable="true">PROJET</div>
            <span id="save-indicator" class="save-indicator">Enregistr√© ‚úî</span>
        </div>
        <div style="font-size:11px; color:var(--text-muted); font-weight:600; text-transform:uppercase;">Programmation V7.8</div>
      </div>
    </div>
    <div class="flex">
        <span style="font-size:12px; color:var(--text-muted);" id="firm-label">BELLECOUR architectes</span>
        <button class="btn btn-secondary btn-icon" id="btn-theme">‚òº</button>
    </div>
  </div>

  <div class="toolbar">
    <div class="tool-group">
        <button class="btn btn-primary" id="btn-save-json">üíæ Sauvegarder (JSON)</button>
        <button class="btn btn-secondary" id="btn-export-csv">CSV</button>
        <button class="btn btn-secondary" id="btn-export-pdf">PDF</button>
    </div>

    <div class="spacer"></div>

    <div class="tool-group" style="border-color: rgba(239,68,68,0.3);">
        <button class="btn btn-secondary" id="btn-undo" disabled>‚Ü© Annuler</button>
        <button class="btn btn-secondary" id="btn-import">Import</button>
        <button class="btn btn-danger" id="btn-clear-all">Effacer</button>
        <button class="btn btn-lock" id="btn-lock" title="Verrouiller">üîì</button>
    </div>
  </div>

  <div class="stats-grid" id="stats-area"></div>

  <div class="filters-box">
    <div class="search-row">
       <input type="text" id="inp-search" class="input" placeholder="Rechercher un local...">
       <div id="dropdown-niveau-container"></div>
       <div id="dropdown-fonction-container"></div>
    </div>
    <div class="chip-container" id="prog-chips"></div>
    <div class="flex" style="margin-top: 16px; padding-top:16px; border-top: 1px solid var(--border-color);">
       <button class="btn btn-secondary btn-icon" id="btn-reset-filters" title="Reset">‚úï</button>
       <div style="width:1px; height:20px; background:var(--border-color);"></div>
       <button class="btn btn-accent" id="btn-save-view">üíæ Sauver Vue</button>
       <div id="views-container" class="chip-container"></div>
       <div class="spacer"></div>
       <button class="btn btn-success" id="btn-add-item" style="background:var(--success);color:white;">‚ûï Ajouter Local</button>
       <button class="btn btn-secondary" id="btn-settings">‚öô Types</button>
    </div>
  </div>

  <div style="text-align:left;">
    <div class="segmented-control">
        <button class="seg-btn active" onclick="App.methods.switchView('list')" id="tab-list">üìã Liste compl√®te</button>
        <button class="seg-btn" onclick="App.methods.switchView('actions')" id="tab-actions">‚ö†Ô∏è Actions requises</button>
    </div>
  </div>

  <div id="main-content"></div>

  <div class="batch-bar" id="batch-bar">
      <span style="font-weight:800; color:var(--primary)" id="batch-count">0 s√©lectionn√©(s)</span>
      <div style="width:1px; height:20px; background:var(--border-color);"></div>
      <select id="batch-field" class="input" style="height:32px; width:120px;" onchange="App.ui.updateBatchInput()">
          <option value="statut">Statut</option>
          <option value="niveau">Niveau</option>
          <option value="programme">Programme</option>
          <option value="priorite">Priorit√©</option>
          <option value="fonction">Fonction</option>
          <option value="local">Renommer (Local)</option>
      </select>
      <div id="batch-input-container">
          <input type="text" id="batch-value" class="input" style="height:32px; width:150px;" placeholder="Valeur...">
      </div>
      <button class="btn btn-primary" style="height:32px" onclick="App.methods.applyBatch()">Appliquer</button>
      <button class="btn btn-secondary" style="height:32px" onclick="App.methods.cancelBatch()">Annuler</button>
  </div>

  <div class="modal-overlay" id="modal-item">
    <div class="modal">
      <h2 style="margin-bottom:20px" id="modal-title">√âditer</h2>
      <form id="form-item" onsubmit="event.preventDefault(); App.methods.saveForm();">
          <input type="hidden" id="f-id">
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px">
             <div><label class="text-muted" style="font-size:11px">PROGRAMME</label><select id="f-programme" class="input" required></select></div>
             <div><label class="text-muted" style="font-size:11px">NIVEAU</label><select id="f-niveau" class="input" required></select></div>
          </div>
          <div style="margin-bottom:12px"><label class="text-muted" style="font-size:11px">FONCTION</label><select id="f-fonction" class="input"></select></div>
          <div style="margin-bottom:12px"><label class="text-muted" style="font-size:11px">LOCAL</label><input type="text" id="f-local" class="input" required></div>
          <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; margin-bottom:12px">
            <div><label class="text-muted" style="font-size:11px">S.U.</label><input type="number" step="0.01" id="f-surf" class="input"></div>
            <div><label class="text-muted" style="font-size:11px">NBR</label><input type="number" id="f-nbr" class="input" value="1"></div>
            <div class="flex" style="align-items:end"><label class="flex" style="cursor:pointer"><input type="checkbox" id="f-isExt"> Ext?</label></div>
          </div>
          <div style="margin-bottom:12px"><label class="text-muted" style="font-size:11px">STATUT</label><select id="f-statut" class="input"></select></div>
          <div style="margin-bottom:12px"><label class="text-muted" style="font-size:11px">PRIORIT√â</label><select id="f-priorite" class="input"></select></div>
          <div style="margin-bottom:20px"><label class="text-muted" style="font-size:11px">REMARQUES / ACTIONS</label><textarea id="f-remarque" class="input" style="height:60px; padding-top:8px"></textarea></div>
          <div class="flex" style="justify-content:end" id="modal-actions-row">
             <button type="button" class="btn btn-danger" id="btn-del-item">Supprimer</button>
             <div class="spacer"></div>
             <button type="button" class="btn btn-secondary" onclick="App.ui.closeModal('modal-item')">Annuler</button>
             <button type="submit" class="btn btn-primary" id="btn-save-item">Enregistrer</button>
          </div>
      </form>
    </div>
  </div>

  <div class="modal-overlay" id="modal-settings">
    <div class="modal">
        <h2 style="margin-bottom:10px">Configuration Types</h2>
        <div style="margin-bottom:12px">
            <select id="set-type-select" class="input" onchange="App.render.settingsList()">
                <option value="programmes">Programmes</option>
                <option value="niveaux">Niveaux</option>
                <option value="fonctions">Fonctions</option>
                <option value="statuts">Statuts</option>
                <option value="priorites">Priorit√©s</option>
            </select>
        </div>
        
        <div style="display:flex; justify-content:space-between; padding:0 12px; margin-bottom:5px; font-size:10px; color:var(--text-muted); font-weight:700">
             <div style="width:30px">FOND</div>
             <div style="width:30px">TXT</div>
             <div style="flex:1; padding-left:10px">NOM</div>
             <div style="width:80px; text-align:right">ACTIONS</div>
        </div>
        
        <div id="settings-list" style="max-height:300px; overflow-y:auto; border:1px solid var(--border-color); border-radius:8px; margin-bottom:12px;"></div>
        
        <label class="text-muted" style="font-size:11px; margin-bottom:4px; display:block">Ajouter un √©l√©ment :</label>
        <div class="flex">
            <input type="text" id="set-new-name" class="input" placeholder="Nom..." style="flex:1">
            <div class="color-picker-wrap" title="Couleur de FOND">
               <input type="color" id="set-new-bg" value="#3B82F6">
            </div>
            <div class="color-picker-wrap" title="Couleur de TEXTE">
               <input type="color" id="set-new-txt" value="#FFFFFF">
            </div>
            <button class="btn btn-success" onclick="App.methods.addType()">+</button>
        </div>
        <div class="flex" style="margin-top:20px; justify-content:end">
            <button class="btn btn-secondary" onclick="App.ui.closeModal('modal-settings')">Fermer</button>
        </div>
    </div>
  </div>

  <div id="toast-container" style="position:fixed; bottom:20px; right:20px; z-index:9000; display:flex; flex-direction:column; gap:10px;"></div>

  <script>
    const APP_VERSION = "7.8";

    const CONFIG = {
      types: {
        programmes: [ 
            { id:1, nom: "BUREAUX", bg: "#3B82F6", txt:"#FFFFFF" }, 
            { id:2, nom: "LOGEMENTS", bg: "#10B981", txt:"#FFFFFF" }, 
            { id:3, nom: "COMMERCES", bg: "#F59E0B", txt:"#FFFFFF" },
            { id:4, nom: "ACTIVIT√âS", bg: "#8B5CF6", txt:"#FFFFFF" },
            { id:5, nom: "PARKING", bg: "#64748B", txt:"#FFFFFF" }
        ],
        niveaux: [ 
            { id:1, nom:"S-1", bg:"#334155", txt:"#F8FAFC"},
            { id:2, nom:"RDC", bg:"#475569", txt:"#FFFFFF"},
            { id:3, nom:"R+1", bg:"#94A3B8", txt:"#FFFFFF"},
            { id:4, nom:"R+2", bg:"#CBD5E1", txt:"#1E293B"},
            { id:5, nom:"R+3", bg:"#E2E8F0", txt:"#0F172A"}
        ],
        fonctions: [ 
            { id:1, nom:"Circulation", bg:"#1E293B", txt:"#94A3B8"},
            { id:2, nom:"Travail", bg:"#1E293B", txt:"#F1F5F9"},
            { id:3, nom:"Sanitaire", bg:"#334155", txt:"#F1F5F9"},
            { id:4, nom:"Technique", bg:"#0F172A", txt:"#64748B"}
        ],
        statuts: [ 
            { id:1, nom: "√Ä CONFIRMER", bg: "#FFF7ED", txt: "#C2410C" }, 
            { id:2, nom: "VALID√â", bg: "#F0FDF4", txt: "#15803D" }, 
            { id:3, nom: "MANQUANT", bg: "#FEF2F2", txt: "#B91C1C" },
            { id:4, nom: "EN √âTUDE", bg: "#EFF6FF", txt: "#1D4ED8" }
        ],
        priorites: [ 
            { id:1, nom:"HAUTE", bg:"#EF4444", txt:"#FFFFFF"}, 
            { id:2, nom:"MOYENNE", bg:"#F59E0B", txt:"#FFFFFF"}, 
            { id:3, nom:"BASSE", bg:"#10B981", txt:"#FFFFFF"} 
        ]
      }
    };

    const App = {
      state: {
        data: [],
        title: "PROJET",
        filters: { search: "", programme: [], niveau: [], fonction: [] },
        sort: { col: "programme", asc: true },
        locked: false,
        history: [],
        savedViews: [],
        types: JSON.parse(JSON.stringify(CONFIG.types)),
        currentView: 'list',
        selectedIds: new Set(),
        openDropdown: null,
        saveTimeout: null
      },

      init: () => {
        try {
            const savedData = localStorage.getItem('v7-data');
            const savedTitle = localStorage.getItem('v7-title');
            const savedViews = localStorage.getItem('v7-views');
            const savedTypes = localStorage.getItem('v7-types');

            if(savedData && savedData !== "undefined") App.state.data = JSON.parse(savedData);
            if(savedTitle) App.state.title = savedTitle;
            if(savedViews && savedViews !== "undefined") App.state.savedViews = JSON.parse(savedViews);
            if(savedTypes && savedTypes !== "undefined") {
                try {
                    App.state.types = JSON.parse(savedTypes);
                } catch(e) {
                    App.state.types = JSON.parse(JSON.stringify(CONFIG.types));
                }
            }

            document.getElementById('app-title').innerText = App.state.title;
            if(localStorage.getItem('v7-theme') === 'light') document.documentElement.classList.add('light');

            window.addEventListener('click', (e) => {
                if(!e.target.closest('.ms-container')) {
                    App.state.openDropdown = null;
                    App.render.filtersUI();
                }
            });

            App.render.modalSelects();
            App.render.all();
            App.events.bindAll();
        } catch(e) {
            console.error("FATAL ERROR INIT:", e);
            alert("Erreur critique. Cliquez sur 'Effacer' pour r√©initialiser.");
        }
      },

      methods: {
        getExportName: () => {
           const d = new Date();
           const yy = d.getFullYear().toString().slice(-2);
           const mm = String(d.getMonth()+1).padStart(2,'0');
           const dd = String(d.getDate()).padStart(2,'0');
           const hh = String(d.getHours()).padStart(2,'0');
           const min = String(d.getMinutes()).padStart(2,'0');
           const cleanTitle = App.state.title.replace(/[^a-z0-9]/gi, '_').toUpperCase();
           return `SBA-${cleanTitle}-PROG-${yy}${mm}${dd}-${hh}${min}`;
        },
        saveLocal: () => {
          localStorage.setItem('v7-data', JSON.stringify(App.state.data));
          localStorage.setItem('v7-title', App.state.title);
          localStorage.setItem('v7-views', JSON.stringify(App.state.savedViews));
          localStorage.setItem('v7-types', JSON.stringify(App.state.types));
          
          // --- AUTO-SAVE FEEDBACK (V7.8) ---
          const indicator = document.getElementById('save-indicator');
          indicator.classList.add('show');
          if(App.state.saveTimeout) clearTimeout(App.state.saveTimeout);
          App.state.saveTimeout = setTimeout(() => {
              indicator.classList.remove('show');
          }, 2000);
        },
        saveJson: () => {
            App.methods.saveLocal();
            const exportObj = {
                title: App.state.title,
                data: App.state.data,
                types: App.state.types,
                version: APP_VERSION // --- VERSIONING (V7.8) ---
            };
            const blob = new Blob([JSON.stringify(exportObj, null, 2)], {type: 'application/json'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${App.methods.getExportName()}.json`;
            link.click();
            App.ui.toast("Fichier JSON g√©n√©r√©");
        },
        pushHistory: () => {
          if(App.state.history.length > 20) App.state.history.shift();
          App.state.history.push(JSON.stringify(App.state.data));
          document.getElementById('btn-undo').disabled = false;
        },
        undo: () => {
          if(App.state.history.length === 0) return;
          App.state.data = JSON.parse(App.state.history.pop());
          if(App.state.history.length === 0) document.getElementById('btn-undo').disabled = true;
          App.methods.saveLocal();
          App.render.all();
          App.ui.toast("Action annul√©e");
        },
        switchView: (v) => {
            App.state.currentView = v;
            document.querySelectorAll('.seg-btn').forEach(b => b.classList.remove('active'));
            if(v === 'list') document.getElementById('tab-list').classList.add('active');
            else document.getElementById('tab-actions').classList.add('active');
            App.render.content();
        },
        
        toggleDropdown: (e, key) => {
            e.stopPropagation();
            App.state.openDropdown = App.state.openDropdown === key ? null : key;
            App.render.filtersUI();
        },
        toggleFilterVal: (key, val) => {
             const arr = App.state.filters[key];
             const idx = arr.indexOf(val);
             if(idx >= 0) arr.splice(idx, 1); else arr.push(val);
             App.render.filtersUI();
             App.render.content();
             App.render.charts();
        },

        toggleSelect: (id) => {
            if(App.state.selectedIds.has(id)) App.state.selectedIds.delete(id);
            else App.state.selectedIds.add(id);
            App.render.batchBar();
        },
        toggleSelectAll: () => {
            const visible = App.helpers.getFiltered();
            const allSelected = visible.every(i => App.state.selectedIds.has(i.id));
            visible.forEach(i => {
                if(allSelected) App.state.selectedIds.delete(i.id);
                else App.state.selectedIds.add(i.id);
            });
            App.render.all();
        },
        cancelBatch: () => {
            App.state.selectedIds.clear();
            App.render.all();
        },
        applyBatch: () => {
            const field = document.getElementById('batch-field').value;
            const valEl = document.getElementById('batch-value-select') || document.getElementById('batch-value');
            const val = valEl.value;
            
            if(!val && !confirm('Valeur vide. Continuer ?')) return;
            App.methods.pushHistory();
            let count = 0;
            App.state.data.forEach(item => {
                if(App.state.selectedIds.has(item.id)) {
                    item[field] = val;
                    count++;
                }
            });
            App.methods.saveLocal();
            App.state.selectedIds.clear();
            App.render.all();
            App.ui.toast(`${count} √©l√©ments modifi√©s`);
        },

        saveForm: () => {
          const id = document.getElementById('f-id').value;
          const formData = {
             programme: document.getElementById('f-programme').value,
             niveau: document.getElementById('f-niveau').value,
             fonction: document.getElementById('f-fonction').value,
             local: document.getElementById('f-local').value,
             surfUnite: parseFloat(document.getElementById('f-surf').value) || 0,
             nombre: parseFloat(document.getElementById('f-nbr').value) || 1,
             isExt: document.getElementById('f-isExt').checked,
             statut: document.getElementById('f-statut').value,
             priorite: document.getElementById('f-priorite').value,
             remarque: document.getElementById('f-remarque').value
          };
          const total = Math.round(formData.surfUnite * formData.nombre * 100) / 100;
          formData.sueInt = formData.isExt ? 0 : total;
          formData.sueExt = formData.isExt ? total : 0;

          App.methods.pushHistory();
          if(id) {
            const idx = App.state.data.findIndex(i => i.id == id);
            if(idx >= 0) App.state.data[idx] = { ...App.state.data[idx], ...formData };
          } else {
            formData.id = Date.now();
            App.state.data.push(formData);
          }
          App.methods.saveLocal();
          App.ui.closeModal('modal-item');
          App.render.all();
        },
        deleteItem: (id) => {
            if(confirm("Supprimer ?")) {
                App.methods.pushHistory();
                App.state.data = App.state.data.filter(i => i.id != id);
                App.methods.saveLocal();
                App.ui.closeModal('modal-item');
                App.render.all();
            }
        },

        saveView: () => {
            const name = prompt("Nom de la vue ?");
            if(name) {
                App.state.savedViews.push({ id: Date.now(), name, filters: JSON.parse(JSON.stringify(App.state.filters)) });
                App.methods.saveLocal();
                App.render.filtersUI();
            }
        },
        loadView: (id) => {
            const v = App.state.savedViews.find(view => view.id === id);
            if(v) {
                App.state.filters = JSON.parse(JSON.stringify(v.filters));
                document.getElementById('inp-search').value = App.state.filters.search;
                App.render.all();
                App.ui.toast(`Vue "${v.name}" charg√©e`);
            }
        },
        deleteView: (id, e) => {
            e.stopPropagation();
            if(confirm('Supprimer cette vue ?')) {
                App.state.savedViews = App.state.savedViews.filter(v => v.id !== id);
                App.methods.saveLocal();
                App.render.filtersUI();
            }
        },
        
        addType: () => {
            const cat = document.getElementById('set-type-select').value;
            const nom = document.getElementById('set-new-name').value;
            const bg = document.getElementById('set-new-bg').value;
            const txt = document.getElementById('set-new-txt').value;
            if(!nom) return;
            const newItem = { id: Date.now(), nom, bg, txt };
            App.state.types[cat].push(newItem);
            App.methods.saveLocal();
            App.render.settingsList();
            App.render.modalSelects();
            App.render.filtersUI();
            App.render.all();
        },
        deleteType: (cat, id) => {
             App.state.types[cat] = App.state.types[cat].filter(t => t.id !== id);
             App.methods.saveLocal();
             App.render.settingsList();
             App.render.modalSelects();
             App.render.filtersUI();
             App.render.all();
        },
        moveType: (cat, id, dir) => {
             const arr = App.state.types[cat];
             const idx = arr.findIndex(i=>i.id===id);
             if(idx<0) return;
             const newIdx = idx+dir;
             if(newIdx<0 || newIdx>=arr.length) return;
             [arr[idx], arr[newIdx]] = [arr[newIdx], arr[idx]];
             App.methods.saveLocal();
             App.render.settingsList();
             App.render.modalSelects();
             App.render.all();
        },
        editType: (cat, id) => {
             const val = prompt("Nouveau nom :");
             if(val) {
                 const t = App.state.types[cat].find(i=>i.id===id);
                 if(t) {
                     const oldName = t.nom;
                     const key = cat.endsWith('s') ? cat.slice(0,-1) : cat; 
                     App.state.data.forEach(d => { if(d[key] === oldName) d[key] = val; });
                     t.nom = val;
                     App.methods.saveLocal();
                     App.render.settingsList();
                     App.render.modalSelects();
                     App.render.all();
                 }
             }
        },
        updateTypeColor: (cat, id, prop, val) => {
            const t = App.state.types[cat].find(i=>i.id===id);
            if(t) {
                t[prop] = val;
                App.methods.saveLocal();
                App.render.all(); 
            }
        },

        exportCsv: () => {
             const headers = ['Programme','Niveau','Fonction','Local','SU','Nbr','Total','Statut','Priorite','Remarque'];
             const rows = App.state.data.map(d => [d.programme, d.niveau, d.fonction, `"${d.local}"`, d.surfUnite, d.nombre, (d.sueInt+d.sueExt), d.statut, d.priorite, `"${d.remarque||''}"`]);
             const csvContent = [headers.join(';'), ...rows.map(r => r.join(';'))].join('\n');
             const blob = new Blob(['\ufeff'+csvContent], {type: 'text/csv;charset=utf-8'});
             const link = document.createElement('a'); link.href = URL.createObjectURL(blob); 
             link.download = `${App.methods.getExportName()}.csv`; 
             link.click();
        },
        exportPdf: () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l','mm','a4');
            doc.text(App.state.title, 14, 15);
            const rows = App.state.data.map(d => [d.programme, d.niveau, d.fonction, d.local, d.surfUnite, d.nombre, (d.sueInt||d.sueExt), d.statut]);
            doc.autoTable({ head:[['Prog','Niv','Fct','Local','SU','Nb','Tot','Statut']], body: rows, startY: 20 });
            doc.save(`${App.methods.getExportName()}.pdf`);
        },
        import: () => {
             const input = document.createElement('input'); input.type='file'; input.accept='.json';
             input.onchange = e => {
                 const reader = new FileReader();
                 reader.onload = () => {
                     try {
                         const json = JSON.parse(reader.result);
                         if(confirm("Remplacer les donn√©es ?")) {
                             App.methods.pushHistory();
                             if(json.pageTitle || json.title) App.state.title = (json.pageTitle || json.title);
                             document.getElementById('app-title').innerText = App.state.title;

                             if(Array.isArray(json)) App.state.data = json;
                             else if(json.data) {
                                 App.state.data = json.data;
                                 if(json.types) App.state.types = json.types;
                             }
                             App.methods.saveLocal();
                             App.render.all();
                         }
                     } catch(err) { alert('Fichier invalide'); }
                 };
                 reader.readAsText(e.target.files[0]);
             };
             input.click();
        }
      },

      helpers: {
         getFiltered: () => {
             const f = App.state.filters;
             return App.state.data.filter(d => {
                 if(f.search && !d.local.toLowerCase().includes(f.search.toLowerCase())) return false;
                 if(f.programme.length && !f.programme.includes(d.programme)) return false;
                 if(f.niveau.length && !f.niveau.includes(d.niveau)) return false; 
                 if(f.fonction.length && !f.fonction.includes(d.fonction)) return false; 
                 return true;
             });
         },
         safe: (str) => {
             if(!str) return '';
             return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
         },
         getStyle: (cat, name) => {
             const t = App.state.types[cat].find(i => i.nom === name);
             if(t) return `background:${t.bg}; color:${t.txt}`;
             return `background:var(--bg-input); color:var(--text-muted)`;
         }
      },

      render: {
        all: () => {
            App.render.filtersUI();
            App.render.charts();
            App.render.content();
            App.render.batchBar();
        },
        modalSelects: () => {
           const fill = (id, list, key='nom') => {
               const el = document.getElementById(id);
               if(!el) return;
               const val = el.value;
               el.innerHTML = el.id.startsWith('f-') ? '' : `<option value="">${el.options[0]?.text || ''}</option>`;
               list.forEach(i => {
                   const opt = document.createElement('option'); opt.value = i[key]; opt.text = i[key];
                   el.appendChild(opt);
               });
               el.value = val;
           };
           fill('f-programme', App.state.types.programmes);
           fill('f-niveau', App.state.types.niveaux);
           fill('f-fonction', App.state.types.fonctions);
           fill('f-statut', App.state.types.statuts);
           fill('f-priorite', App.state.types.priorites);
        },
        
        filtersUI: () => {
            const mkDropdown = (key, label, list) => {
                const selected = App.state.filters[key];
                const isOpen = App.state.openDropdown === key;
                let btnText = `${label} (Tous)`;
                if(selected.length === 1) btnText = selected[0];
                else if(selected.length > 1) btnText = `${label} (${selected.length})`;

                return `
                <div class="ms-container" onclick="App.methods.toggleDropdown(event, '${key}')">
                    <div class="ms-btn" style="${isOpen ? 'border-color:var(--primary)' : ''}">
                        ${App.helpers.safe(btnText)} <span style="font-size:10px">‚ñº</span>
                    </div>
                    <div class="ms-dropdown ${isOpen ? 'show' : ''}" onclick="event.stopPropagation()">
                        ${list.map(i => `
                            <div class="ms-option" onclick="App.methods.toggleFilterVal('${key}', '${App.helpers.safe(i.nom)}')">
                                <input type="checkbox" class="ms-checkbox" ${selected.includes(i.nom) ? 'checked' : ''} readonly>
                                <span>${App.helpers.safe(i.nom)}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            };

            document.getElementById('dropdown-niveau-container').innerHTML = mkDropdown('niveau', 'Niveaux', App.state.types.niveaux);
            document.getElementById('dropdown-fonction-container').innerHTML = mkDropdown('fonction', 'Fonctions', App.state.types.fonctions);
            
            const pc = document.getElementById('prog-chips'); pc.innerHTML = '';
            App.state.types.programmes.forEach(p => {
                const active = App.state.filters.programme.includes(p.nom);
                const btn = document.createElement('div'); btn.className = `chip ${active?'active':''}`;
                btn.style.borderColor = p.bg; btn.style.color = active ? p.txt : p.bg;
                if(active) btn.style.background = p.bg;
                btn.innerText = p.nom;
                btn.onclick = () => {
                    const idx = App.state.filters.programme.indexOf(p.nom);
                    if(idx>-1) App.state.filters.programme.splice(idx,1); else App.state.filters.programme.push(p.nom);
                    App.render.filtersUI();
                    App.render.content();
                    App.render.charts();
                };
                pc.appendChild(btn);
            });
            
            const vc = document.getElementById('views-container'); vc.innerHTML = '';
            App.state.savedViews.forEach(v => {
                const d = document.createElement('div'); d.className = 'chip view-chip';
                d.innerHTML = `<span>${v.name}</span><span class="chip-del">√ó</span>`;
                d.querySelector('span').onclick = () => App.methods.loadView(v.id);
                d.querySelector('.chip-del').onclick = (e) => App.methods.deleteView(v.id, e);
                vc.appendChild(d);
            });
        },

        charts: () => {
            const data = App.helpers.getFiltered();
            const totInt = data.reduce((a,b)=>a+(b.sueInt||0),0);
            const totExt = data.reduce((a,b)=>a+(b.sueExt||0),0);
            
            const mkChart = (title, groupKey, palette) => {
                const groups = {};
                data.forEach(i => { 
                    if(i.sueInt>0) groups[i[groupKey]] = (groups[i[groupKey]]||0) + i.sueInt; 
                });
                
                let conic = [], deg=0, listHTML='';
                const total = totInt || 1; 

                palette.forEach(type => {
                     const v = groups[type.nom] || 0;
                     if(v > 0) {
                         const col = type.bg || '#888';
                         const pct = (v/total)*100;
                         conic.push(`${col} ${deg}% ${deg+pct}%`);
                         deg += pct;
                         listHTML += `<div class="legend-item"><div><span class="dot" style="background:${col}"></span>${type.nom}</div><div>${Math.round(v)}m¬≤</div></div>`;
                     }
                });
                const knowns = palette.map(p=>p.nom);
                let unknownSum = 0;
                Object.keys(groups).forEach(k => { if(!knowns.includes(k)) unknownSum += groups[k]; });
                if(unknownSum > 0) {
                     const pct = (unknownSum/total)*100;
                     conic.push(`#888 ${deg}% ${deg+pct}%`);
                     listHTML += `<div class="legend-item"><div><span class="dot" style="background:#888"></span>Autre</div><div>${Math.round(unknownSum)}m¬≤</div></div>`;
                }

                const grad = conic.length ? `conic-gradient(${conic.join(', ')})` : 'var(--bg-input)';
                return `<div class="card"><div style="font-size:11px;font-weight:700;color:var(--text-muted);margin-bottom:10px">${title}</div><div class="chart-row"><div class="donut" style="background:${grad}"></div><div class="legend">${listHTML||'Aucune donn√©e'}</div></div></div>`;
            };

            const html = `
               <div class="card" style="border-left:4px solid var(--primary); display:flex; flex-direction:column; justify-content:center;">
                  <div style="font-size:11px;font-weight:700;color:var(--text-muted)">SURFACE INT.</div>
                  <div style="font-size:24px;font-weight:800;color:var(--primary)">${totInt.toLocaleString('fr-FR')} <span style="font-size:14px">m¬≤</span></div>
               </div>
               <div class="card" style="border-left:4px solid var(--success); display:flex; flex-direction:column; justify-content:center;">
                  <div style="font-size:11px;font-weight:700;color:var(--text-muted)">SURFACE EXT.</div>
                  <div style="font-size:24px;font-weight:800;color:var(--success)">${totExt.toLocaleString('fr-FR')} <span style="font-size:14px">m¬≤</span></div>
               </div>
               ${mkChart('PAR PROGRAMME', 'programme', App.state.types.programmes)}
               ${mkChart('PAR NIVEAU', 'niveau', App.state.types.niveaux)}
            `;
            document.getElementById('stats-area').innerHTML = html;
        },

        content: () => {
            const container = document.getElementById('main-content');
            const data = App.helpers.getFiltered();
            const sorted = [...data].sort((a,b) => {
                 let vA=a[App.state.sort.col], vB=b[App.state.sort.col];
                 if(typeof vA==='string') return App.state.sort.asc ? vA.localeCompare(vB):vB.localeCompare(vA);
                 return App.state.sort.asc ? vA-vB : vB-vA;
            });

            if(App.state.currentView === 'list') {
                container.innerHTML = `<div class="table-wrap"><table><thead><tr>
                   <th style="width:40px; text-align:center"><input type="checkbox" onclick="App.methods.toggleSelectAll()"></th>
                   <th onclick="App.state.sort.col='programme';App.render.content()">Prog</th>
                   <th onclick="App.state.sort.col='niveau';App.render.content()">Niv</th>
                   <th onclick="App.state.sort.col='fonction';App.render.content()">Fct</th>
                   <th onclick="App.state.sort.col='local';App.render.content()">Local</th>
                   <th class="text-right">SU</th><th class="text-center">Nb</th><th class="text-right">Tot</th>
                   <th onclick="App.state.sort.col='statut';App.render.content()">Statut</th>
                </tr></thead><tbody id="tb"></tbody></table></div>`;
                
                const tb = document.getElementById('tb');
                if(!sorted.length) tb.innerHTML = `<tr><td colspan="9" class="text-center" style="padding:30px">Vide</td></tr>`;
                sorted.forEach(i => {
                    const sel = App.state.selectedIds.has(i.id);
                    const prog = App.state.types.programmes.find(p=>p.nom===i.programme);
                    const st = App.state.types.statuts.find(s=>s.nom===i.statut);
                    
                    const nivStyle = App.helpers.getStyle('niveaux', i.niveau);
                    const fnStyle = App.helpers.getStyle('fonctions', i.fonction);

                    const tr = document.createElement('tr');
                    if(sel) tr.style.background = "rgba(59, 130, 246, 0.1)";
                    tr.innerHTML = `
                      <td class="text-center" onclick="event.stopPropagation()"><input type="checkbox" ${sel?'checked':''} onchange="App.methods.toggleSelect(${i.id})"></td>
                      <td style="color:${prog?prog.bg:'inherit'};font-weight:700">${i.programme}</td>
                      <td><span class="badge" style="${nivStyle}">${i.niveau}</span></td>
                      <td><span class="badge" style="${fnStyle}">${i.fonction||'-'}</span></td>
                      <td><b>${i.local}</b></td>
                      <td class="text-right">${i.surfUnite||'-'}</td>
                      <td class="text-center">${i.nombre}</td>
                      <td class="text-right" style="font-weight:700; color:${i.sueInt?'var(--primary)':'var(--success)'}">${(i.sueInt||i.sueExt).toLocaleString('fr-FR')}</td>
                      <td>${i.statut ? `<span class="badge" style="background:${st?st.bg:'#eee'}; color:${st?st.txt:'#333'}">${i.statut}</span>`:''}</td>
                    `;
                    tr.onclick = () => App.ui.openModalItem(i);
                    tb.appendChild(tr);
                });

            } else {
                const actions = sorted.filter(i => i.statut && i.statut !== 'VALID√â');
                const prioMap = { 'HAUTE':1, 'MOYENNE':2, 'BASSE':3 };
                actions.sort((a,b) => (prioMap[a.priorite]||9) - (prioMap[b.priorite]||9));

                if(!actions.length) { container.innerHTML = '<div class="text-center" style="padding:40px; color:var(--text-muted)">Aucune action requise.</div>'; return; }
                
                container.innerHTML = `<div class="actions-grid" id="ag"></div>`;
                const ag = document.getElementById('ag');
                actions.forEach(i => {
                    const prio = App.state.types.priorites.find(p=>p.nom===i.priorite);
                    const col = prio ? prio.bg : 'var(--border-color)';
                    const card = document.createElement('div');
                    card.className = 'action-card';
                    card.style.borderLeftColor = col;
                    card.onclick = () => App.ui.openModalItem(i);
                    card.innerHTML = `
                      <div class="ac-header">
                        <span style="font-size:11px; font-weight:700; color:${col}">${i.priorite || 'SANS PRIORIT√â'}</span>
                        <span class="badge" style="background:var(--bg-input)">${i.statut}</span>
                      </div>
                      <div class="ac-body">
                         <div style="font-size:16px; margin-bottom:4px">${i.local}</div>
                         <div style="color:var(--text-muted); font-size:12px">${i.programme} - ${i.niveau}</div>
                         ${i.remarque ? `<div style="margin-top:8px; padding:8px; background:var(--bg-input); border-radius:6px; font-size:13px">"${i.remarque}"</div>` : ''}
                      </div>
                      <div class="ac-footer">
                         <span>Action requise</span>
                         <button class="btn btn-secondary" style="height:28px; padding:0 10px; font-size:11px">Modifier</button>
                      </div>
                    `;
                    ag.appendChild(card);
                });
            }
        },
        batchBar: () => {
             const bar = document.getElementById('batch-bar');
             const count = App.state.selectedIds.size;
             if(count > 0 && !App.state.locked) {
                 bar.classList.add('visible');
                 document.getElementById('batch-count').innerText = `${count} s√©lectionn√©(s)`;
                 App.ui.updateBatchInput();
             } else {
                 bar.classList.remove('visible');
             }
        },
        settingsList: () => {
             const cat = document.getElementById('set-type-select').value;
             const list = App.state.types[cat];
             const div = document.getElementById('settings-list');
             div.innerHTML = '';
             list.forEach(item => {
                 const row = document.createElement('div');
                 row.className = "settings-list-item";
                 row.innerHTML = `
                   <div style="display:flex; align-items:center; gap:5px;">
                      <input type="color" class="color-picker-mini" value="${item.bg||'#000000'}" onchange="App.methods.updateTypeColor('${cat}', ${item.id}, 'bg', this.value)" title="Fond">
                      <input type="color" class="color-picker-mini" value="${item.txt||'#ffffff'}" onchange="App.methods.updateTypeColor('${cat}', ${item.id}, 'txt', this.value)" title="Texte">
                   </div>
                   <div style="flex:1; margin-left:10px; font-weight:600; font-size:13px">${item.nom}</div>
                   <div>
                     <button class="btn-action-sm" onclick="App.methods.moveType('${cat}', ${item.id}, -1)">‚ñ≤</button>
                     <button class="btn-action-sm" onclick="App.methods.moveType('${cat}', ${item.id}, 1)">‚ñº</button>
                     <button class="btn-action-sm" onclick="App.methods.editType('${cat}', ${item.id})">‚úé</button>
                     <button class="btn-action-sm" style="color:var(--danger)" onclick="App.methods.deleteType('${cat}', ${item.id})">√ó</button>
                   </div>
                 `;
                 div.appendChild(row);
             });
        }
      },

      ui: {
        toast: (msg) => {
            const t = document.createElement('div'); t.className='toast';
            t.style.cssText = "background:var(--bg-card); padding:12px 20px; border-radius:8px; border-left:4px solid var(--primary); box-shadow:0 5px 15px rgba(0,0,0,0.3); animation:slideIn 0.3s forwards";
            t.innerText = msg;
            document.getElementById('toast-container').appendChild(t);
            setTimeout(()=>t.remove(), 3000);
        },
        updateBatchInput: () => {
            const field = document.getElementById('batch-field').value;
            const container = document.getElementById('batch-input-container');
            const typeMap = { 'programme':'programmes', 'niveau':'niveaux', 'fonction':'fonctions', 'statut':'statuts', 'priorite':'priorites' };
            if(typeMap[field]) {
                const list = App.state.types[typeMap[field]];
                let opts = list.map(i => `<option value="${i.nom}">${i.nom}</option>`).join('');
                container.innerHTML = `<select id="batch-value-select" class="input" style="height:32px; width:150px;">${opts}</select>`;
            } else {
                container.innerHTML = `<input type="text" id="batch-value" class="input" style="height:32px; width:150px;" placeholder="Valeur...">`;
            }
        },
        openModalItem: (item=null) => {
            const form = document.getElementById('form-item');
            form.reset();
            document.getElementById('f-id').value = '';
            document.getElementById('btn-del-item').classList.add('hidden');
            document.getElementById('modal-title').innerText = item ? "Modifier Local" : "Nouveau Local";
            
            if(item) {
                document.getElementById('f-id').value = item.id;
                document.getElementById('f-programme').value = item.programme;
                document.getElementById('f-niveau').value = item.niveau;
                document.getElementById('f-fonction').value = item.fonction;
                document.getElementById('f-local').value = item.local;
                document.getElementById('f-surf').value = item.surfUnite;
                document.getElementById('f-nbr').value = item.nombre;
                document.getElementById('f-isExt').checked = item.isExt;
                document.getElementById('f-statut').value = item.statut;
                document.getElementById('f-priorite').value = item.priorite;
                document.getElementById('f-remarque').value = item.remarque || '';
                document.getElementById('btn-del-item').classList.remove('hidden');
                document.getElementById('btn-del-item').onclick = () => App.methods.deleteItem(item.id);
            }
            const inputs = form.querySelectorAll('input, select, textarea, button[type="submit"], #btn-del-item');
            inputs.forEach(el => el.disabled = App.state.locked);
            document.getElementById('modal-item').classList.add('open');
        },
        closeModal: (id) => document.getElementById(id).classList.remove('open')
      },

      events: {
        bindAll: () => {
            document.getElementById('btn-theme').onclick = () => { 
                document.documentElement.classList.toggle('light'); 
                localStorage.setItem('v7-theme', document.documentElement.classList.contains('light')?'light':'dark'); 
            };
            
            document.getElementById('btn-lock').onclick = () => { 
                App.state.locked = !App.state.locked; 
                document.getElementById('btn-lock').innerText = App.state.locked ? 'üîí' : 'üîì'; 
                document.getElementById('btn-lock').classList.toggle('locked', App.state.locked);
                
                document.getElementById('btn-clear-all').disabled = App.state.locked;
                document.getElementById('btn-import').disabled = App.state.locked;
                document.getElementById('btn-add-item').disabled = App.state.locked;
                document.getElementById('btn-undo').disabled = App.state.locked;

                App.ui.toast(App.state.locked ? "Lecture seule" : "√âdition activ√©e"); 
                if(App.state.locked) App.methods.cancelBatch();
            };
            
            document.getElementById('inp-search').oninput = (e) => { App.state.filters.search = e.target.value; App.render.content(); };
            document.getElementById('btn-reset-filters').onclick = () => { App.state.filters = {search:"",programme:[],niveau:[],fonction:[]}; document.getElementById('inp-search').value=""; App.render.filtersUI(); App.render.all(); };
            
            document.getElementById('btn-save-json').onclick = App.methods.saveJson;
            document.getElementById('btn-undo').onclick = App.methods.undo;
            document.getElementById('btn-clear-all').onclick = () => { if(confirm("Tout effacer ?")) { App.methods.pushHistory(); App.state.data=[]; App.methods.saveLocal(); App.render.all(); }};
            document.getElementById('btn-add-item').onclick = () => !App.state.locked && App.ui.openModalItem();
            document.getElementById('app-title').onblur = (e) => { App.state.title = e.target.innerText; App.methods.saveLocal(); };
            
            document.getElementById('btn-save-view').onclick = App.methods.saveView;
            document.getElementById('btn-settings').onclick = () => { document.getElementById('modal-settings').classList.add('open'); App.render.settingsList(); };
            
            document.getElementById('btn-export-csv').onclick = App.methods.exportCsv;
            document.getElementById('btn-export-pdf').onclick = App.methods.exportPdf;
            document.getElementById('btn-import').onclick = App.methods.import;
        }
      }
    };

    // --- SERVICE WORKER REGISTRATION (V7.8 - PWA) ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
             // On tente d'enregistrer le SW si le fichier existe
             // Note: Cela √©chouera silencieusement si le fichier n'est pas pr√©sent (mode simple)
             navigator.serviceWorker.register('./service-worker.js').catch(err => console.log('SW non trouv√© (mode local simple)'));
        });
    }

    window.addEventListener('DOMContentLoaded', App.init);
  </script>
</body>
</html>
