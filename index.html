<!DOCTYPE html>
<html lang="fr"><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="CLIENT - PROJET">
  <title>PROGRAMMATION</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* --- DESIGN SYSTEM V5.4 --- */
    :root {
      /* Palette Dark (D√©faut) */
      --bg-body: #0F172A; --bg-card: #1E293B; --bg-input: #0F172A;
      --bg-hover: #334155; --border-color: #334155;
      --text-main: #F1F5F9; --text-muted: #94A3B8; --text-inv: #0F172A;
      
      --primary: #3B82F6; --primary-hover: #2563EB;
      --success: #10B981; --danger: #EF4444; --warning: #F59E0B;
      
      --radius: 12px;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    :root.light {
      /* Palette Light */
      --bg-body: #F8FAFC; --bg-card: #FFFFFF; --bg-input: #F1F5F9;
      --bg-hover: #E2E8F0; --border-color: #CBD5E1;
      --text-main: #0F172A; --text-muted: #64748B; --text-inv: #FFFFFF;
      --primary: #2563EB; --primary-hover: #1D4ED8;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    
    html, body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
      background: var(--bg-body); color: var(--text-main); 
      min-height: 100vh; font-size: 15px; 
      line-height: 1.6; 
      transition: background-color 0.3s ease, color 0.3s ease; 
    }
    body { padding: 24px; padding-bottom: 140px; max-width: 1500px; margin: 0 auto; }
    
    /* HEADER */
    .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 32px; flex-wrap: wrap; gap: 16px; padding-bottom: 24px; border-bottom: 1px solid var(--border-color); }
    .header-left { display: flex; align-items: center; gap: 20px; }
    .header-right { display: flex; align-items: center; gap: 16px; }
    
    .logo { 
      width: 52px; height: 52px; 
      background: linear-gradient(135deg, var(--primary), #8B5CF6); 
      border-radius: 16px; display: flex; align-items: center; justify-content: center; 
      font-size: 26px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); color: white; 
    }
    
    .title { font-size: 26px; font-weight: 800; color: var(--text-main); letter-spacing: -0.5px; cursor: text; border: 1px dashed transparent; border-radius: 6px; padding: 0 8px; transition: all 0.2s; margin-left: -8px; }
    .title:hover { border-color: var(--border-color); background: var(--bg-hover); }
    .title:focus { outline: none; border-color: var(--primary); background: var(--bg-input); }
    .title.locked { cursor: default; border: none; pointer-events: none; }
    
    .subtitle { font-size: 14px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-top: 2px; }
    .firm-name { font-family: 'Inter', sans-serif; font-size: 16px; font-weight: 600; color: var(--text-muted); letter-spacing: -0.3px; user-select: none; border-right: 1px solid var(--border-color); padding-right: 20px; }
    
    .theme-btn { background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-main); width: 44px; height: 44px; border-radius: 12px; cursor: pointer; font-size: 20px; transition: all 0.2s; display:flex; align-items:center; justify-content:center; }
    .theme-btn:hover { background: var(--bg-hover); transform: translateY(-1px); }
    
    .global-tools { display: flex; gap: 12px; margin-bottom: 40px; flex-wrap: wrap; align-items: center; }
    
    /* BUTTONS */
    .btn { height: 44px; padding: 0 20px; border-radius: var(--radius); font-size: 14px; font-weight: 600; border: 1px solid transparent; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; box-shadow: var(--shadow-sm); white-space: nowrap; }
    .btn:active { transform: translateY(1px); }
    .btn-add { background: var(--success); color: white; }
    .btn-add:hover { filter: brightness(1.1); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-hover); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
    .btn-secondary { background: var(--bg-card); color: var(--text-main); border-color: var(--border-color); }
    .btn-secondary:hover { background: var(--bg-hover); border-color: var(--text-muted); }
    .btn-export { background: #8B5CF6; color: white; }
    .btn-export:hover { background: #7C3AED; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3); }
    .btn-danger { background: rgba(239,68,68,0.1); color: var(--danger); }
    .btn-danger:hover { background: rgba(239,68,68,0.2); }
    .btn-lock { background: var(--bg-input); color: var(--text-muted); border: 1px solid var(--border-color); width: 44px; padding: 0; }
    .btn-lock.locked { background: rgba(239,68,68,0.1); color: var(--danger); border-color: rgba(239,68,68,0.3); }
    .btn-separator { width: 1px; height: 28px; background: var(--border-color); margin: 0 4px; }
    .spacer { flex: 1; }

    /* STATS GRID */
    .stats-grid { 
        display: grid; 
        grid-template-columns: 0.7fr 0.7fr 1.3fr 1.3fr; 
        gap: 24px; 
        margin-bottom: 40px; 
    }
    
    .card { 
        background: var(--bg-card); 
        border: 1px solid var(--border-color); 
        border-radius: 18px; 
        padding: 28px; 
        position: relative; 
        overflow: hidden; 
        box-shadow: var(--shadow-md); 
        transition: transform 0.2s, box-shadow 0.2s;
        display: flex; 
        flex-direction: column; 
    }
    .card:hover { box-shadow: var(--shadow-lg); }
    .stat-main-card { grid-column: span 1; min-height: 140px; }
    
    .stat-label { 
        font-size: 12px; color: var(--text-muted); font-weight: 700; 
        text-transform: uppercase; letter-spacing: 1.2px; margin-bottom: 16px; 
        display: block; width: 100%;
    }
    
    .stat-value { font-size: 36px; font-weight: 800; letter-spacing: -1px; font-variant-numeric: tabular-nums; margin-top: auto; margin-bottom: auto;}
    .stat-unit { font-size: 18px; color: var(--text-muted); font-weight: 500; margin-left: 6px; }
    
    .chart-card { grid-column: span 1; min-height: 180px; }
    
    @media (max-width: 1100px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 600px) { .stats-grid { grid-template-columns: 1fr; } .header-right { width: 100%; justify-content: space-between; } .firm-name { border: none; } }

    .chart-content { display: flex; align-items: center; gap: 24px; margin-top: auto; }
    .donut-container { position: relative; width: 80px; height: 80px; flex-shrink: 0; }
    .donut { width: 100%; height: 100%; border-radius: 50%; }
    .donut-hole { position: absolute; top: 20%; left: 20%; width: 60%; height: 60%; background: var(--bg-card); border-radius: 50%; }
    .legend-list { flex: 1; display: flex; flex-direction: column; gap: 8px; min-width: 0; }
    .legend-item { display: flex; align-items: center; justify-content: space-between; font-size: 13px; }
    .legend-info { display: flex; align-items: center; gap: 10px; overflow: hidden; }
    .legend-color { width: 12px; height: 12px; border-radius: 4px; flex-shrink: 0; }
    .legend-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; color: var(--text-muted); }
    .legend-value { color: var(--text-main); font-weight: 600; font-variant-numeric: tabular-nums; }

    /* FILTERS & SEARCH */
    .filter-section { display: flex; gap: 24px; align-items: flex-start; margin-bottom: 32px; flex-wrap: wrap; }
    
    .filter-container { 
        flex: 1; display: flex; flex-direction: column; gap: 16px; 
        background: var(--bg-card); padding: 20px; border-radius: 18px; 
        border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); min-width: 0; 
    }
    
    .search-row { 
        display: grid; gap: 16px; grid-template-columns: 1fr 1.5fr 1.5fr; 
    }
    @media (max-width: 600px) { .search-row { grid-template-columns: 1fr; gap: 16px; } }
    
    .search-box { 
        width: 100%; padding: 12px 16px; border-radius: var(--radius); 
        border: 1px solid var(--border-color); background: var(--bg-input); 
        color: var(--text-main); font-size: 15px; transition: border-color 0.2s; height: 48px; 
    }
    .search-box:focus { outline: none; border-color: var(--primary); }
    .chips-container { flex: 1; display: flex; flex-wrap: wrap; gap: 10px; align-content: flex-start; padding-top: 4px; }
    .filter-chip { padding: 8px 16px; border-radius: 24px; font-size: 13px; font-weight: 600; border: 1px solid var(--border-color); cursor: pointer; transition: all 0.2s; background: var(--bg-card); color: var(--text-muted); }
    .filter-chip.active { background: var(--primary); color: white; border-color: var(--primary); }

    .tabs { display: inline-flex; gap: 4px; margin-bottom: 24px; padding: 5px; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 14px; }
    .tab { padding: 10px 24px; border-radius: 10px; font-size: 14px; font-weight: 600; border: none; cursor: pointer; white-space: nowrap; transition: all 0.2s; }
    .tab.active { background: var(--bg-card); color: var(--text-main); box-shadow: var(--shadow-sm); }
    .tab.inactive { background: transparent; color: var(--text-muted); }
    .tab.inactive:hover { color: var(--text-main); }

    /* MULTISELECT DROPDOWN */
    .ms-container { flex: 1; position: relative; }
    .ms-btn { width: 100%; height: 48px; padding: 0 16px; border-radius: var(--radius); border: 1px solid var(--border-color); background: var(--bg-input); color: var(--text-main); font-size: 14px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    .ms-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 14px; margin-top: 8px; max-height: 280px; overflow-y: auto; z-index: 50; padding: 10px; box-shadow: var(--shadow-lg); display: none; }
    .ms-dropdown.show { display: block; }
    .ms-option { display: flex; align-items: center; gap: 12px; padding: 10px 12px; border-radius: 8px; cursor: pointer; font-size: 14px; transition: background 0.1s; }
    .ms-option:hover { background: var(--bg-hover); }

    .text-blue { color: #60A5FA; } .text-green { color: var(--success); }
    :root.light .text-blue { color: var(--primary); } 
    
    /* --- TABLE STYLING --- */
    .data-table { width: 100%; border-collapse: separate; border-spacing: 0; background: var(--bg-card); border-radius: 20px; border: 1px solid var(--border-color); overflow: hidden; font-size: 15px; box-shadow: var(--shadow-md); }
    .data-table thead { background: var(--bg-input); }
    .data-table th { padding: 20px 18px; text-align: left; font-size: 12px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.8px; border-bottom: 1px solid var(--border-color); cursor: pointer; user-select: none; }
    .data-table th:hover { color: var(--text-main); background: var(--bg-hover); }
    .data-table td { padding: 22px 18px; vertical-align: middle; border-bottom: 1px solid var(--border-color); color: var(--text-main); }
    .data-table tbody tr { transition: background 0.15s; cursor: pointer; }
    .data-table tbody tr:hover { background: var(--bg-hover); }
    .data-table tbody tr:hover td { background: transparent; }
    .data-table tbody tr:last-child td { border-bottom: none; }
    .col-num { font-weight: 600; font-variant-numeric: tabular-nums; font-size: 15px; }
    
    /* BATCH / CHECKBOX STYLES */
    .checkbox-col { width: 50px; text-align: center !important; padding: 0 !important; }
    .row-checkbox { width: 20px; height: 20px; accent-color: var(--primary); cursor: pointer; border-radius: 5px; }
    
    /* BATCH ACTION BAR */
    .batch-bar {
        position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(150%);
        background: var(--bg-card); border: 1px solid var(--primary);
        padding: 16px 24px; border-radius: 100px; box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        display: flex; align-items: center; gap: 20px; z-index: 90;
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        color: var(--text-main);
    }
    .batch-bar.visible { transform: translateX(-50%) translateY(0); }
    .batch-count { font-weight: 800; color: var(--primary); white-space: nowrap; font-size: 15px; }
    .batch-sep { width: 1px; height: 24px; background: var(--border-color); }
    .batch-select { padding: 10px 16px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--bg-input); color: var(--text-main); font-size: 14px; height: 42px; }
    .batch-input { padding: 10px 16px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--bg-input); color: var(--text-main); font-size: 14px; width: 180px; height: 42px; }
    
    .badge { padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 700; white-space: nowrap; letter-spacing: 0.3px; display: inline-block; border: 1px solid transparent; }
    .badge-local { background: var(--bg-input); color: var(--text-main); border-color: var(--border-color); font-size: 13px; padding: 6px 14px; }
    
    .data-row-mobile { display: none; }
    .data-row { background: var(--bg-card); border-radius: 18px; margin-bottom: 16px; border: 1px solid var(--border-color); cursor: pointer; overflow: hidden; box-shadow: var(--shadow-sm); }
    .data-row-inner { padding: 24px; border-left: 6px solid transparent; }
    
    @media (max-width: 899px) { .data-table { display: none; } .data-row-mobile { display: block; } }
    
    .btn-clear { width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: var(--bg-input); color: var(--text-muted); border: 1px solid var(--border-color); font-size: 16px; cursor: pointer;}
    .btn-clear:hover { background: rgba(239,68,68,0.1); color: var(--danger); border-color: var(--danger); }
    
    .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(6px); display: flex; align-items: center; justify-content: center; z-index: 100; padding: 20px; }
    .modal { background: var(--bg-card); border-radius: 24px; width: 100%; max-width: 720px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); border: 1px solid var(--border-color); }
    .modal-header { padding: 24px 32px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
    .modal-title { font-size: 20px; font-weight: 800; color: var(--text-main); }
    .modal-close { font-size: 28px; color: var(--text-muted); background: none; border: none; cursor: pointer; transition: color 0.2s; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
    .modal-close:hover { background: var(--bg-hover); color: var(--text-main); }
    .modal-body { padding: 32px; overflow-y: auto; }
    
    .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 28px; }
    .form-col-span-2 { grid-column: span 2; }
    @media (max-width: 600px) { .form-grid { grid-template-columns: 1fr; } .form-col-span-2 { grid-column: span 1; } }
    
    .form-label { display: block; font-size: 12px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; margin-bottom: 10px; letter-spacing: 0.8px; }
    .form-input, .form-select, .form-textarea { width: 100%; padding: 14px; border-radius: var(--radius); border: 1px solid var(--border-color); background: var(--bg-input); color: var(--text-main); font-size: 15px; transition: all 0.2s; }
    .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15); }
    .form-input:disabled, .form-select:disabled, .form-textarea:disabled { opacity: 0.6; cursor: not-allowed; background: var(--bg-hover); }
    
    .form-actions { display: flex; gap: 16px; justify-content: flex-end; margin-top: 40px; padding-top: 24px; border-top: 1px solid var(--border-color); }
    
    .settings-list { border: 1px solid var(--border-color); border-radius: 16px; overflow: hidden; background: var(--bg-input); }
    .settings-item { display: flex; justify-content: space-between; align-items: center; padding: 14px 20px; background: var(--bg-card); border-bottom: 1px solid var(--border-color); }
    .settings-item:last-child { border-bottom: none; }
    .settings-item-text { font-size: 15px; font-weight: 500; display: flex; align-items: center; gap: 12px; color: var(--text-main); }
    
    .settings-item-actions { display: flex; gap: 10px; align-items: center; }
    .btn-action-sm { height: 36px; padding: 0 14px; font-size: 13px; font-weight: 600; border-radius: 10px; display: inline-flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.2s; cursor: pointer; border: 1px solid var(--border-color); background: var(--bg-input); color: var(--text-muted); }
    .btn-action-sm:hover { background: var(--bg-hover); color: var(--text-main); }
    .btn-action-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); border-color: rgba(239, 68, 68, 0.3); }
    .btn-action-danger:hover { background: rgba(239, 68, 68, 0.2); }
    
    .checkbox-row { display: flex; align-items: center; gap: 14px; padding: 10px 0; }
    .checkbox-input { width: 22px; height: 22px; accent-color: var(--primary); cursor: pointer; border-radius: 6px; }
    .color-input { width: 100%; height: 48px; cursor: pointer; padding: 0; border: none; border-radius: var(--radius); }
    
    .footer-legal { margin-top: 80px; padding-top: 32px; border-top: 1px solid var(--border-color); text-align: center; color: var(--text-muted); font-size: 13px; opacity: 0.8; max-width: 600px; margin-left: auto; margin-right: auto; line-height: 1.6; }
    
    .hidden { display: none !important; }
    
    .empty-state { text-align: center; padding: 100px 24px; color: var(--text-muted); font-size: 16px; background: var(--bg-card); border-radius: 24px; border: 2px dashed var(--border-color); max-width: 100%; }
    .sort-icon { display: inline-block; margin-left: 6px; font-size: 11px; opacity: 0.7; }
    .lock-notice { background: rgba(245,158,11,0.1); color: var(--warning); padding: 14px; border-radius: 12px; margin-bottom: 24px; font-size: 14px; text-align:center; border: 1px solid rgba(245,158,11,0.3); display: flex; align-items: center; justify-content: center; gap: 10px; }
  </style>
  
  <script>
    // --- FORCE UPDATE / CACHE BUSTER ---
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(function(registrations) {
        for(let registration of registrations) {
          registration.unregister();
        }
      });
    }
  </script>
</head>
<body>
  <div id="app"></div>

  <script>
    // New function to safely access localStorage
    function safeGetItem(key) {
        try {
            return localStorage.getItem(key);
        } catch (e) {
            console.warn(`Erreur d'acc√®s √† localStorage pour la cl√© '${key}'. Utilisation des donn√©es int√©gr√©es.`);
            return null; 
        }
    }

    // Initial Types (VIDES)
    // __TYPES_START__
    const initialTypes = {
      "programmes": [], 
      "statuts": [ 
        { "id": 1, "nom": "√Ä CONFIRMER", "couleur": "#F59E0B", "bgColor": "#FFFBEB", "textColor": "#B45309" },
        { "id": 2, "nom": "MANQUANT", "couleur": "#EF4444", "bgColor": "#FEF2F2", "textColor": "#B91C1C" },
        { "id": 3, "nom": "MODIFI√â", "couleur": "#3B82F6", "bgColor": "#EFF6FF", "textColor": "#1D4ED8" },
        { "id": 4, "nom": "VALID√â", "couleur": "#10B981", "bgColor": "#ECFDF5", "textColor": "#047857" }
      ],
      "priorites": [ 
        { "id": 1, "nom": "HAUTE", "couleur": "#DC2626", "bgColor": "#FEF2F2", "textColor": "#DC2626" },
        { "id": 2, "nom": "MOYENNE", "couleur": "#D97706", "bgColor": "#FFFBEB", "textColor": "#D97706" },
        { "id": 3, "nom": "BASSE", "couleur": "#16A34A", "bgColor": "#ECFDF5", "textColor": "#16A34A" }
      ],
      "fonctions": [], 
      "niveaux": []    
    };
    // __TYPES_END__

    // Initial Data (VIDES)
    // __DATA_START__
    const initialData = [];
    // __DATA_END__

    // State
    let pageTitle = safeGetItem('coffim-page-title-v2') || "PROJET (Importer donn√©es)";
    let data = JSON.parse(safeGetItem('coffim-alve-data-v2')) || JSON.parse(JSON.stringify(initialData));
    let types = JSON.parse(safeGetItem('coffim-alve-types-v2')) || JSON.parse(JSON.stringify(initialTypes));
    
    let isLocked = safeGetItem('coffim-locked') === 'true';

    // BATCH STATE
    let selectedIds = new Set();
    let batchField = 'statut';
    let batchValue = ''; 

    let filters = { programme: [], search: '', niveau: [], fonction: [] };
    let currentView = 'liste';
    let modalItem = null;
    let modalType = null;
    let settingsModal = false;
    let clearModal = false;
    let editingType = null;
    let editingTypeItem = null;
    let sortCol = null;
    let sortAsc = true;
    let openDropdown = null; 
    
    let isLightMode = safeGetItem('coffim-theme') === 'light';
    if (isLightMode) document.documentElement.classList.add('light');

    function toggleTheme() {
      isLightMode = !isLightMode;
      if (isLightMode) document.documentElement.classList.add('light');
      else document.documentElement.classList.remove('light');
      localStorage.setItem('coffim-theme', isLightMode ? 'light' : 'dark');
      render(); 
    }
    
    function toggleLock() {
        isLocked = !isLocked;
        if(isLocked) selectedIds.clear(); // Clear selection on lock
        try { localStorage.setItem('coffim-locked', isLocked); } catch(e) {} 
        render();
    }

    const saveData = () => { try { localStorage.setItem('coffim-alve-data-v2', JSON.stringify(data)); } catch(e) {} };
    const saveTypes = () => { try { localStorage.setItem('coffim-alve-types-v2', JSON.stringify(types)); } catch(e) {} };
    
    const safe = (str) => {
      if (!str) return '';
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    };

    const chartPalette = [ '#3B82F6', '#10B981', '#8B5CF6', '#F59E0B', '#06B6D4', '#6366F1', '#EC4899', '#64748B' ];
    const niceColors = [ {bg:'#DBEAFE', txt:'#1E40AF'}, {bg:'#D1FAE5', txt:'#065F46'}, {bg:'#FEE2E2', txt:'#991B1B'}, {bg:'#FEF3C7', txt:'#92400E'}, {bg:'#E0E7FF', txt:'#3730A3'}, {bg:'#FAE8FF', txt:'#86198F'} ];
    
    const getAutoBadgeStyle = (str) => {
        if(!str) return {bg:'var(--bg-input)', txt:'var(--text-muted)'};
        let hash = 0;
        for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
        const idx = Math.abs(hash) % niceColors.length;
        return niceColors[idx];
    };

    const getProgrammeColor = (nom) => { const p = types.programmes.find(p => p.nom === nom); return p ? p.couleur : '#64748B'; };
    const getStatutStyle = (nom) => { const s = types.statuts.find(s => s.nom === nom); return s ? { bg: s.bgColor, text: s.textColor } : { bg: '#475569', text: '#E2E8F0' }; };
    const getNiveauStyle = (nom) => { const n = types.niveaux.find(x => x.nom === nom); if (n && n.bgColor) return { bg: n.bgColor, txt: n.textColor }; return getAutoBadgeStyle(nom); };
    const getPrioriteStyle = (nom) => { const p = types.priorites.find(p => p.nom === nom); return p ? { bg: p.bgColor, text: p.textColor } : { bg: '#475569', text: '#E2E8F0' }; };
    
    const priorityOrder = types.priorites.map(p => p.nom); 
    const getPriorityValue = (item) => item.priorite ? priorityOrder.indexOf(item.priorite) : 999; 

    const getStats = (items) => {
      const totalSueInt = items.reduce((a, d) => a + (d.sueInt || 0), 0);
      const totalSueExt = items.reduce((a, d) => a + (d.sueExt || 0), 0);
      const actionsRequises = items.filter(d => d.statut).length;
      const byProgrammeInt = items.reduce((a, d) => { if(d.sueInt > 0) a[d.programme] = (a[d.programme] || 0) + d.sueInt; return a; }, {});
      const byNiveauInt = items.reduce((a, d) => { if(d.sueInt > 0) a[d.niveau] = (a[d.niveau] || 0) + d.sueInt; return a; }, {});
      return { totalSueInt, totalSueExt, actionsRequises, byProgrammeInt, byNiveauInt };
    };

    const getFiltered = () => data.filter(d => {
      if (filters.programme.length && !filters.programme.includes(d.programme)) return false;
      if (filters.niveau.length && !filters.niveau.includes(d.niveau)) return false;
      if (filters.fonction.length && !filters.fonction.includes(d.fonction)) return false;
      if (filters.search && !d.local.toLowerCase().includes(filters.search.toLowerCase())) return false;
      return true;
    });
    
    const getSorted = (items) => {
      if (!sortCol) return items;
      return [...items].sort((a, b) => {
        let valA = a[sortCol]; let valB = b[sortCol];
        if (valA === valB) return 0;
        if (valA == null) return 1; if (valB == null) return -1;
        if (typeof valA === 'string' && typeof valB === 'string') return sortAsc ? valA.localeCompare(valB) : valB.localeCompare(a);
        if (valA < valB) return sortAsc ? -1 : 1;
        if (valA > valB) return sortAsc ? 1 : -1;
        return 0;
      });
    };

    const getNextId = (arr) => Math.max(...arr.map(i => i.id), 0) + 1;

    const getConicGradient = (entries, total, colorCallback, isDefaultPalette) => {
      if (!total || total === 0) return 'var(--bg-input) 0% 100%';
      let gradient = []; let currentDeg = 0;
      entries.forEach(([key, value], idx) => {
        const percent = (value / total) * 100;
        const color = isDefaultPalette ? chartPalette[idx % chartPalette.length] : colorCallback(key);
        gradient.push(`${color} ${currentDeg}% ${currentDeg + percent}%`);
        currentDeg += percent;
      });
      return gradient.join(', ');
    };

    window.addEventListener('click', (e) => {
        if (openDropdown && !e.target.closest('.ms-container')) {
            openDropdown = null;
            render();
        }
    });

    // BATCH FUNCTIONS
    window.toggleSelectRow = (id) => {
        if (selectedIds.has(id)) selectedIds.delete(id);
        else selectedIds.add(id);
        render();
    };

    window.toggleSelectAll = () => {
        const filtered = getFiltered();
        const allVisibleSelected = filtered.every(i => selectedIds.has(i.id));
        if (allVisibleSelected) filtered.forEach(i => selectedIds.delete(i.id));
        else filtered.forEach(i => selectedIds.add(i.id));
        render();
    };
    
    window.setBatchField = (val) => { 
        batchField = val; 
        batchValue = ''; 
        render(); 
    };
    
    window.setBatchValue = (val) => {
        batchValue = val;
    }

    window.applyBatch = () => {
        let val = batchValue;
        if (!val && confirm("Appliquer une valeur vide ?") === false) return;
        
        if (confirm(`Appliquer cette modification √† ${selectedIds.size} √©l√©ment(s) ?`)) {
            data.forEach(item => { 
                if (selectedIds.has(item.id)) {
                     // Application de la valeur avec conversion si n√©cessaire
                     if (batchField === 'surfUnite') item.surfUnite = parseFloat(val) || 0;
                     else if (batchField === 'nombre') item.nombre = parseFloat(val) || 1;
                     else if (batchField === 'isExt') item.isExt = (val === 'true');
                     else item[batchField] = val;

                     // Recalcul automatique des totaux si on touche aux surfaces/nombre/ext
                     if (['surfUnite', 'nombre', 'isExt'].includes(batchField)) {
                         const unit = item.surfUnite || 0;
                         const nb = item.nombre || 1;
                         const total = Math.round(unit * nb * 100) / 100;
                         if (item.isExt) { item.sueExt = total; item.sueInt = 0; }
                         else { item.sueInt = total; item.sueExt = 0; }
                     }
                } 
            });
            saveData();
            selectedIds.clear(); 
            batchValue = '';
            render();
        }
    };
    
    window.cancelBatch = () => { selectedIds.clear(); batchValue = ''; render(); };

    function renderBatchBar() {
        if (selectedIds.size === 0 || isLocked) return '';
        
        const fields = [
            {v:'statut', l:'Statut'},
            {v:'priorite', l:'Priorit√©'},
            {v:'niveau', l:'Niveau'},
            {v:'programme', l:'Programme'},
            {v:'fonction', l:'Fonction'},
            {v:'local', l:'Nom Local'},
            {v:'surfUnite', l:'Surface Unit.'},
            {v:'nombre', l:'Nombre'},
            {v:'isExt', l:'Ext√©rieur ?'},
            {v:'details', l:'D√©tails'},
            {v:'action', l:'Action/Remarque'}
        ];

        let inputHtml = '';
        const onChg = 'onchange="setBatchValue(this.value)"';
        const onInp = 'oninput="setBatchValue(this.value)"'; 
        
        if (batchField === 'statut') inputHtml = `<select id="batch-select-input" class="batch-select" ${onChg}><option value="">‚Äî</option>${types.statuts.map(s => `<option ${batchValue === s.nom ? 'selected' : ''}>${safe(s.nom)}</option>`).join('')}</select>`;
        else if (batchField === 'priorite') inputHtml = `<select id="batch-select-input" class="batch-select" ${onChg}><option value="">‚Äî</option>${types.priorites.map(p => `<option ${batchValue === p.nom ? 'selected' : ''}>${safe(p.nom)}</option>`).join('')}</select>`;
        else if (batchField === 'niveau') inputHtml = `<select id="batch-select-input" class="batch-select" ${onChg}><option value="">‚Äî</option>${types.niveaux.map(n => `<option ${batchValue === n.nom ? 'selected' : ''}>${safe(n.nom)}</option>`).join('')}</select>`;
        else if (batchField === 'programme') inputHtml = `<select id="batch-select-input" class="batch-select" ${onChg}><option value="">‚Äî</option>${types.programmes.map(p => `<option ${batchValue === p.nom ? 'selected' : ''}>${safe(p.nom)}</option>`).join('')}</select>`;
        else if (batchField === 'fonction') inputHtml = `<select id="batch-select-input" class="batch-select" ${onChg}><option value="">‚Äî</option>${types.fonctions.map(f => `<option ${batchValue === f.nom ? 'selected' : ''}>${safe(f.nom)}</option>`).join('')}</select>`;
        else if (batchField === 'isExt') {
             inputHtml = `<select id="batch-select-input" class="batch-select" ${onChg}>
                <option value="false" ${batchValue === 'false' ? 'selected' : ''}>Non (Int√©rieur)</option>
                <option value="true" ${batchValue === 'true' ? 'selected' : ''}>Oui (Ext√©rieur)</option>
             </select>`;
        }
        else if (batchField === 'surfUnite' || batchField === 'nombre') {
             inputHtml = `<input type="number" step="0.01" id="batch-text-input" class="batch-input" placeholder="0" value="${safe(batchValue)}" ${onInp}>`;
        }
        else {
             // Text input for local, details, action
             inputHtml = `<input id="batch-text-input" class="batch-input" placeholder="Nouvelle valeur..." value="${safe(batchValue)}" ${onInp}>`;
        }

        return `
            <div class="batch-bar visible">
                <div class="batch-count">${selectedIds.size} s√©lectionn√©(s)</div>
                <div class="batch-sep"></div>
                <select class="batch-select" onchange="setBatchField(this.value)">${fields.map(f => `<option value="${f.v}" ${batchField === f.v ? 'selected' : ''}>${f.l}</option>`).join('')}</select>
                <div class="batch-sep"></div>
                ${inputHtml}
                <button class="btn btn-primary" style="height:32px; padding:0 12px;" onclick="applyBatch()">OK</button>
                <button class="btn btn-secondary" style="height:32px; padding:0 12px;" onclick="cancelBatch()">Annuler</button>
            </div>
        `;
    }

    function render() {
      const activeEl = document.activeElement;
      const focusedId = activeEl ? activeEl.id : null;
      const selectionStart = activeEl ? activeEl.selectionStart : null;
      const selectionEnd = activeEl ? activeEl.selectionEnd : null;

      const filtered = getFiltered();
      const sorted = getSorted(filtered);
      const stats = getStats(filtered);
      
      const actions = filtered.filter(d => d.statut).sort((a, b) => getPriorityValue(a) - getPriorityValue(b));
      const getSortIcon = (col) => sortCol === col ? (sortAsc ? '<span class="sort-icon">‚ñ≤</span>' : '<span class="sort-icon">‚ñº</span>') : '';
      
      const renderChartCard = (title, dataObj, total, colorCallback, sortTypesArray = null, usePalette = false) => {
        const hasData = total > 0;
        let entries = Object.entries(dataObj);
        if (sortTypesArray) entries.sort((a, b) => {
            const ia = sortTypesArray.findIndex(t => t.nom === a[0]);
            const ib = sortTypesArray.findIndex(t => t.nom === b[0]);
            return (ia === -1 ? 999 : ia) - (ib === -1 ? 999 : ib);
        });
        
        const gradient = hasData ? getConicGradient(entries, total, colorCallback, usePalette) : 'var(--bg-hover) 0% 100%';
        const listHtml = entries.map(([key, val], idx) => {
          const pct = Math.round((val/total)*100);
          const color = usePalette ? chartPalette[idx % chartPalette.length] : colorCallback(key);
          return `<div class="legend-item"><div class="legend-info"><div class="legend-color" style="background:${color}"></div><div class="legend-name">${safe(key)}</div></div><div style="display:flex;gap:8px;align-items:center;"><div class="legend-value">${val.toLocaleString('fr-FR')} m¬≤</div><div class="legend-percent">${pct}%</div></div></div>`;
        }).join('');

        return `
          <div class="card chart-card">
            <div class="stat-label">${safe(title)}</div>
            <div class="chart-content">
              <div class="donut-container"><div class="donut" style="background: conic-gradient(${gradient})"></div><div class="donut-hole"></div></div>
              <div class="legend-list">${hasData ? listHtml : '<div class="empty-state" style="padding:0;text-align:left;font-size:12px;border:none;background:transparent;">Aucune donn√©e</div>'}</div>
            </div>
          </div>`;
      };
      
      const renderMultiSelect = (key, label, items) => {
          const selected = filters[key] || [];
          const isOpen = openDropdown === key;
          let btnText = selected.length === 1 ? selected[0] : (selected.length > 1 ? `${label} (${selected.length})` : `${label} (Tous)`);
          
          return `
            <div class="ms-container" onclick="toggleDropdown(event, '${key}')">
                <div class="ms-btn">${safe(btnText)} <span class="ms-arrow">‚ñº</span></div>
                <div class="ms-dropdown ${isOpen ? 'show' : ''}" onclick="event.stopPropagation()">
                    ${items.map(i => `<div class="ms-option" onclick="toggleFilterVal('${key}', '${safe(i.nom)}')"><input type="checkbox" class="ms-checkbox" ${selected.includes(i.nom) ? 'checked' : ''} readonly><span>${safe(i.nom)}</span></div>`).join('')}
                </div>
            </div>`;
      };
      
      const allFilteredSelected = filtered.length > 0 && filtered.every(i => selectedIds.has(i.id));

      document.getElementById('app').innerHTML = `
        <div class="header">
          <div class="header-left">
            <div class="logo">B</div>
            <div>
              <div id="page-title" class="title ${isLocked ? 'locked' : ''}" contenteditable="${!isLocked}" onblur="updateTitle(this.innerText)" onkeydown="if(event.key==='Enter'){event.preventDefault(); this.blur();}">${safe(pageTitle)}</div>
              <div class="subtitle">Programmation</div>
            </div>
          </div>
          <div class="header-right"><div class="firm-name">BELLECOUR architectes</div><button class="theme-btn" onclick="toggleTheme()" title="Changer le th√®me">${isLightMode ? '‚òæ' : '‚òº'}</button></div>
        </div>

        <div class="global-tools">
          <button class="btn btn-lock ${isLocked ? 'locked' : ''}" onclick="toggleLock()" title="${isLocked ? 'D√©verrouiller pour √©diter' : 'Verrouiller en lecture seule'}">${isLocked ? 'üîí' : 'üîì'}</button>
          
          <button class="btn btn-primary" onclick="downloadJson()">üíæ Sauvegarder</button>
          <div class="btn-separator"></div>

          <button class="btn btn-export" onclick="exportCsv()">Export CSV</button>
          <button class="btn btn-export" onclick="exportPdf()">PDF</button>
          <div class="btn-separator"></div>
          
          ${!isLocked ? `<button class="btn btn-secondary" onclick="importData()">Import</button>` : ''}
          <div class="spacer"></div>
          ${!isLocked ? `<button class="btn btn-danger" onclick="openClearModal()">Effacer</button>` : ''}
        </div>
        
        ${isLocked ? `<div class="lock-notice">üîí Mode lecture seule actif. D√©verrouillez le cadenas pour modifier les donn√©es ou utiliser la s√©lection multiple.</div>` : ''}

        <div class="stats-grid">
          <div class="card stat-main-card">
            <div class="stat-label">SURFACE PROGRAMME INTERIEUR</div>
            <div style="margin: auto 0;"><span class="stat-value text-blue">${stats.totalSueInt.toLocaleString('fr-FR')}</span><span class="stat-unit">m¬≤</span></div>
          </div>
          <div class="card stat-main-card">
            <div class="stat-label">SURFACE PROGRAMME EXTERIEUR</div>
            <div style="margin: auto 0;"><span class="stat-value text-green">${stats.totalSueExt.toLocaleString('fr-FR')}</span><span class="stat-unit">m¬≤</span></div>
          </div>
          ${renderChartCard('REPARTITION PROGRAMME PAR ENTITE', stats.byProgrammeInt, stats.totalSueInt, (k) => getProgrammeColor(k), types.programmes, false)}
          ${renderChartCard('REPARTITION PROGRAMME PAR NIVEAU', stats.byNiveauInt, stats.totalSueInt, (k) => getNiveauStyle(k).bg, types.niveaux, true)}
        </div>

        <div class="filter-section">
          <div class="filter-container">
             <div class="search-row">
                <input type="search" id="main-search" class="search-box" placeholder="Rechercher un local..." value="${safe(filters.search)}" oninput="setSearch(this.value)">
                ${renderMultiSelect('niveau', 'Niveaux', types.niveaux)}
                ${renderMultiSelect('fonction', 'Fonctions', types.fonctions)}
             </div>
             <div class="chips-container">
              ${types.programmes.map(p => `<button class="filter-chip ${filters.programme.includes(p.nom) ? 'active' : 'inactive'}" onclick="toggleProgramme('${safe(p.nom)}')">${safe(p.nom)}</button>`).join('')}
              ${(filters.programme.length || filters.niveau.length || filters.fonction.length || filters.search) ? `<button class="btn btn-clear" onclick="clearFilters()">‚úï</button>` : ''}
            </div>
          </div>
           <div class="action-bar" style="margin:0; align-self:stretch; display:flex; flex-direction:column; gap:10px;">
              ${!isLocked ? `<button class="btn btn-add" style="flex:1" onclick="openModal('add')">‚ûï Ajouter local</button>` : ''}
              ${!isLocked ? `<button class="btn btn-secondary" style="flex:1" onclick="openSettings()">üé® G√©rer Types</button>` : ''}
           </div>
        </div>
        
        <div class="tabs">
          <button class="tab ${currentView === 'liste' ? 'active' : 'inactive'}" onclick="setView('liste')">üìã Liste compl√®te</button>
          <button class="tab ${currentView === 'actions' ? 'active' : 'inactive'}" onclick="setView('actions')">‚ö†Ô∏è Actions requises (${stats.actionsRequises})</button>
        </div>

        <div class="${currentView !== 'liste' ? 'hidden' : ''}" style="width: 100%;">
          ${sorted.length === 0 ? '<div class="empty-state">Aucun r√©sultat ne correspond √† votre recherche.</div>' : `
          <table class="data-table">
            <thead>
              <tr>
                ${!isLocked ? `<th class="checkbox-col" onclick="toggleSelectAll()"><input type="checkbox" class="row-checkbox" ${allFilteredSelected ? 'checked' : ''} onclick="event.stopPropagation(); toggleSelectAll()"></th>` : ''}
                <th onclick="toggleSort('programme')">Programme ${getSortIcon('programme')}</th>
                <th onclick="toggleSort('niveau')">Niveau ${getSortIcon('niveau')}</th>
                <th onclick="toggleSort('fonction')">Fonction ${getSortIcon('fonction')}</th>
                <th onclick="toggleSort('local')">Local ${getSortIcon('local')}</th>
                <th onclick="toggleSort('surfUnite')" style="text-align:right">S.U. Unit. ${getSortIcon('surfUnite')}</th>
                <th onclick="toggleSort('isExt')" style="text-align:center">Ext. ${getSortIcon('isExt')}</th>
                <th onclick="toggleSort('nombre')" style="text-align:center">Nbr ${getSortIcon('nombre')}</th>
                <th onclick="toggleSort('sueInt')" style="text-align:right">Total Int. ${getSortIcon('sueInt')}</th>
                <th onclick="toggleSort('sueExt')" style="text-align:right">Total Ext. ${getSortIcon('sueExt')}</th>
                <th onclick="toggleSort('statut')">Statut ${getSortIcon('statut')}</th>
              </tr>
            </thead>
            <tbody>
              ${sorted.map(item => {
                const statutStyle = item.statut ? getStatutStyle(item.statut) : null;
                const niveauStyle = getNiveauStyle(item.niveau);
                const fonctionStyle = getAutoBadgeStyle(item.fonction);
                const isSelected = selectedIds.has(item.id);
                return `<tr onclick="openModal('edit', ${item.id})" style="${isSelected ? 'background:var(--bg-hover)' : ''}">
                  ${!isLocked ? `<td class="checkbox-col" onclick="event.stopPropagation()"><input type="checkbox" class="row-checkbox" ${isSelected ? 'checked' : ''} onchange="toggleSelectRow(${item.id})"></td>` : ''}
                  <td style="color:${getProgrammeColor(item.programme)};font-weight:600">${safe(item.programme)}</td>
                  <td><span class="badge" style="background:${niveauStyle.bg};color:${niveauStyle.txt}">${safe(item.niveau)}</span></td>
                  <td><span class="badge" style="background:${fonctionStyle.bg};color:${fonctionStyle.txt}">${safe(item.fonction)}</span></td>
                  <td><span class="badge badge-local">${safe(item.local)}</span></td>
                  <td style="text-align:right" class="col-num">${item.surfUnite ? item.surfUnite : '‚Äì'}</td>
                  <td style="text-align:center"><span style="font-size:16px; color: var(--text-muted)">${item.isExt ? '‚óè' : ''}</span></td>
                  <td style="text-align:center">${item.nombre || 1}</td>
                  <td style="text-align:right;color:${item.sueInt?'var(--primary)':'inherit'};font-weight:${item.sueInt?'600':'400'}" class="col-num">${item.sueInt ? item.sueInt : '‚Äì'}</td>
                  <td style="text-align:right;color:${item.sueExt?'var(--success)':'inherit'};font-weight:${item.sueExt?'600':'400'}" class="col-num">${item.sueExt ? item.sueExt : '‚Äì'}</td>
                  <td>${item.statut ? `<span class="badge" style="background:${statutStyle.bg};color:${statutStyle.text}">${safe(item.statut)}</span>` : ''}</td>
                </tr>`}).join('')}
            </tbody>
          </table>
          <div class="data-row-mobile">
            ${sorted.map(item => {
              const statutStyle = item.statut ? getStatutStyle(item.statut) : null;
              const niveauStyle = getNiveauStyle(item.niveau);
              const fonctionStyle = getAutoBadgeStyle(item.fonction);
              const isSelected = selectedIds.has(item.id);
              return `<div class="data-row" onclick="openModal('edit', ${item.id})" style="${isSelected ? 'background:var(--bg-hover);border-color:var(--primary)' : ''}">
                <div class="data-row-inner" style="border-left-color:${getProgrammeColor(item.programme)}">
                  <div class="data-row-header">
                    ${!isLocked ? `<input type="checkbox" class="row-checkbox" style="margin-right:12px" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); toggleSelectRow(${item.id})">` : ''}
                    <span class="data-row-title">${safe(item.local)} ${(item.nombre && item.nombre > 1) ? `<span style="color:var(--text-muted);font-weight:400">√ó${item.nombre}</span>` : ''}</span>
                    <div style="text-align:right">${item.sueInt ? `<div style="color:var(--primary);font-weight:700">${item.sueInt} m¬≤</div>` : ''}${item.sueExt ? `<div style="color:var(--success);font-weight:700">${item.sueExt} m¬≤ (Ext)</div>` : ''}</div>
                  </div>
                  <div class="data-row-meta">
                    <span class="chip" style="color:${getProgrammeColor(item.programme)};font-weight:700;border-color:transparent">${safe(item.programme)}</span>
                    <span class="badge" style="background:${niveauStyle.bg};color:${niveauStyle.txt}">${safe(item.niveau)}</span>
                    <span class="badge" style="background:${fonctionStyle.bg};color:${fonctionStyle.txt}">${safe(item.fonction)}</span>
                    ${item.statut ? `<span class="badge" style="background:${statutStyle.bg};color:${statutStyle.text}">${safe(item.statut)}</span>` : ''}
                  </div>
                </div>
              </div>`}).join('')}
          </div>`}
        </div>

        <div class="${currentView !== 'actions' ? 'hidden' : ''}" style="width: 100%;">
          ${actions.length === 0 ? '<div class="empty-state">Aucune action requise</div>' : `
          <div style="display:flex; flex-direction:column; gap:10px">
            ${actions.map(item => {
              const statutStyle = item.statut ? getStatutStyle(item.statut) : null;
              const prioStyle = item.priorite ? getPrioriteStyle(item.priorite) : null;
              const niveauStyle = getNiveauStyle(item.niveau);
              const fonctionStyle = getAutoBadgeStyle(item.fonction);
              const isSelected = selectedIds.has(item.id);
              return `<div class="data-row" onclick="openModal('edit', ${item.id})" style="${isSelected ? 'background:var(--bg-hover);border-color:var(--primary)' : ''}">
                <div class="data-row-inner" style="border-left-color:${getProgrammeColor(item.programme)}">
                  <div class="data-row-header" style="justify-content: space-between; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border-color);">
                    <div style="display:flex;align-items:center;">
                        ${!isLocked ? `<input type="checkbox" class="row-checkbox" style="margin-right:12px" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); toggleSelectRow(${item.id})">` : ''}
                        <span class="data-row-title">${safe(item.local)}</span>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                        <span class="badge" style="background:${niveauStyle.bg};color:${niveauStyle.txt}; font-weight: 500;">${safe(item.niveau)}</span>
                        <span class="badge" style="background:${fonctionStyle.bg};color:${fonctionStyle.txt}; font-weight: 500;">${safe(item.fonction)}</span>
                    </div>
                  </div>
                  ${item.priorite || item.action ? 
                    `<div style="font-size:13px; color:var(--text-main); background:var(--bg-input); padding:10px; border-radius:6px; border: 1px solid var(--border-color);">
                        <div style="display:flex; align-items: center; margin-bottom: 8px; gap: 10px; flex-wrap: wrap;">
                            <span style="color: var(--primary); font-weight: 600; text-transform: uppercase;">Action Requise :</span>
                            ${item.priorite ? `<span class="badge" style="background:${prioStyle.bg};color:${prioStyle.text}; font-size:12px;">${safe(item.priorite)}</span>` : ''}
                        </div>
                        <div style="font-weight: 500; padding-left: 10px; color: var(--text-muted);">${safe(item.action || 'Aucune action d√©taill√©e.')}</div>
                    </div>` : ''}
                  <div class="data-row-meta" style="margin-top: 12px; display: flex; align-items: center; gap: 12px;">
                    <span class="chip" style="color:${getProgrammeColor(item.programme)};font-weight:700;border-color:transparent">${safe(item.programme)}</span>
                    ${item.statut ? `<span class="badge" style="background:${statutStyle.bg};color:${statutStyle.text}">${safe(item.statut)}</span>` : ''}
                  </div>
                </div>
              </div>`}).join('')}
          </div>`}
        </div>
        
        ${renderBatchBar()}
        <div class="footer-legal">Cet outil est la propri√©t√© exclusive de BELLECOUR architectes.</div>
        ${modalType ? renderItemModal() : ''}
        ${settingsModal ? renderSettingsModal() : ''}
        ${clearModal ? renderClearModal() : ''}
      `;

      if (focusedId) {
        const el = document.getElementById(focusedId);
        if (el) {
          el.focus();
          if (selectionStart !== null) { el.setSelectionRange(selectionStart, selectionEnd); }
        }
      }
    }

    // Modal Functions
    function renderItemModal() {
      const item = modalItem || { programme: types.programmes[0]?.nom || '', niveau: types.niveaux[0]?.nom || '', fonction: '', local: '', surfUnite: '', isExt: false, sueInt: '', sueExt: '', details: '', statut: '', action: '', priorite: '' };
      const isEdit = modalType === 'edit';
      const dis = isLocked ? 'disabled' : '';
      return `
        <div class="modal-overlay" onclick="closeModal()"><div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header"><span class="modal-title">${isEdit ? (isLocked ? 'D√©tails du local' : 'Modifier le local') : 'Nouveau local'}</span><button class="modal-close" onclick="closeModal()">√ó</button></div>
            <div class="modal-body">
              <div class="form-grid">
                <div><label class="form-label">Programme</label><select ${dis} class="form-select" id="f-programme">${types.programmes.map(p => `<option ${item.programme === p.nom ? 'selected' : ''}>${safe(p.nom)}</option>`).join('')}</select></div>
                <div><label class="form-label">Niveau</label><select ${dis} class="form-select" id="f-niveau">${types.niveaux.map(n => `<option ${item.niveau === n.nom ? 'selected' : ''}>${safe(n.nom)}</option>`).join('')}</select></div>
                <div class="form-col-span-2"><label class="form-label">Fonction</label><select ${dis} class="form-select" id="f-fonction">${types.fonctions.map(f => `<option ${item.fonction === f.nom ? 'selected' : ''}>${safe(f.nom)}</option>`).join('')}</select></div>
                <div class="form-col-span-2"><label class="form-label">Nom du Local *</label><input ${dis} class="form-input" id="f-local" value="${safe(item.local || '')}" required placeholder="Ex: Bureau direction"></div>
                <div class="form-col-span-2 checkbox-row"><input ${dis} type="checkbox" class="checkbox-input" id="f-isExt" ${item.isExt ? 'checked' : ''} onchange="calculateAuto()"><label for="f-isExt" style="font-size:13px;cursor:pointer;color:var(--text-main)">Surface ext√©rieure (Terrasse, Parking...)</label></div>
                <div style="grid-column: span 2; display:grid; grid-template-columns: repeat(3, 1fr); gap:16px;">
                    <div><label class="form-label">S.U. (m¬≤)</label><input ${dis} type="number" class="form-input" id="f-surfUnite" value="${item.surfUnite || ''}" oninput="calculateAuto()"></div>
                    <div><label class="form-label">Qt√©</label><input ${dis} type="number" class="form-input" id="f-nombre" value="${item.nombre || 1}" min="1" oninput="calculateAuto()"></div>
                    <div><label class="form-label">Total</label><input ${dis} type="number" class="form-input" id="f-totalCalc" value="${item.isExt ? (item.sueExt||0) : (item.sueInt||0)}" readonly style="background:var(--bg-hover);color:var(--text-muted);border-color:transparent"><input type="hidden" id="f-sueInt" value="${item.sueInt || ''}"><input type="hidden" id="f-sueExt" value="${item.sueExt || ''}"></div>
                </div>
                <div class="form-col-span-2"><label class="form-label">D√©tails / Finitions</label><textarea ${dis} class="form-textarea" id="f-details" rows="2">${safe(item.details || '')}</textarea></div>
                <div><label class="form-label">Statut</label><select ${dis} class="form-select" id="f-statut"><option value="">‚Äî</option>${types.statuts.map(s => `<option ${item.statut === s.nom ? 'selected' : ''}>${safe(s.nom)}</option>`).join('')}</select></div>
                <div><label class="form-label">Priorit√©</label><select ${dis} class="form-select" id="f-priorite"><option value="">‚Äî</option>${types.priorites.map(p => `<option ${item.priorite === p.nom ? 'selected' : ''}>${safe(p.nom)}</option>`).join('')}</select></div>
                <div class="form-col-span-2"><label class="form-label">Action / Remarque</label><textarea ${dis} class="form-textarea" id="f-action" rows="1">${safe(item.action || '')}</textarea></div>
              </div>
              <div class="form-actions">
                ${!isLocked && isEdit ? `<button class="btn btn-danger" onclick="deleteItem(${item.id})">Supprimer</button>` : ''}
                ${!isLocked && isEdit ? `<button class="btn btn-secondary" onclick="duplicateItem(${item.id})">Dupliquer</button>` : ''}
                <div style="flex:1"></div>
                <button class="btn btn-secondary" onclick="closeModal()">Fermer</button>
                ${!isLocked ? `<button class="btn btn-primary" onclick="saveItem(${isEdit ? item.id : 'null'})">Enregistrer</button>` : ''}
              </div>
            </div></div></div>`;
    }

    function renderSettingsModal() {
      const typeConfigs = [ { key: 'programmes', title: 'Programmes', hasColor: true, colorType: 'single' }, { key: 'statuts', title: 'Statuts', hasColor: true, colorType: 'badge' }, { key: 'priorites', title: 'Priorit√©s', hasColor: true, colorType: 'badge' }, { key: 'niveaux', title: 'Niveaux', hasColor: true, colorType: 'badge' }, { key: 'fonctions', title: 'Fonctions', hasColor: false } ];
      return `
        <div class="modal-overlay" onclick="closeSettings()"><div class="modal" style="max-width: 600px;" onclick="event.stopPropagation()">
            <div class="modal-header"><span class="modal-title">Configuration</span><button class="modal-close" onclick="closeSettings()">√ó</button></div>
            <div class="modal-body">
              ${typeConfigs.map(cfg => `
                <div class="settings-section" style="margin-bottom:24px"><div class="settings-title" style="font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;margin-bottom:8px;letter-spacing:1px">${cfg.title}</div>
                  <div class="settings-list">${types[cfg.key].map(item => `
                      <div class="settings-item"><span class="settings-item-text">${cfg.hasColor ? `<span class="legend-color" style="margin-right:10px; width:12px; height:12px; background:${item.couleur || item.bgColor}"></span>` : ''}${safe(item.nom)}</span>
                        <div class="settings-item-actions"><button class="btn-action-sm" onclick="moveTypeItem('${cfg.key}', ${item.id}, -1)">‚ñ≤</button><button class="btn-action-sm" onclick="moveTypeItem('${cfg.key}', ${item.id}, 1)">‚ñº</button><button class="btn-action-sm" onclick="editTypeItem('${cfg.key}', ${item.id})">‚úé</button><button class="btn-action-sm btn-action-danger" onclick="deleteTypeItem('${cfg.key}', ${item.id})">‚úï</button></div>
                      </div>`).join('')}</div>
                  <button class="btn btn-primary" style="width:100%; margin-top:8px; font-size:12px; height:32px" onclick="addTypeItem('${cfg.key}')">‚ûï Ajouter</button>
                </div>`).join('')}
              <div class="form-actions"><button class="btn btn-secondary" onclick="resetTypes()">R√©tablir d√©faut</button><button class="btn btn-primary" onclick="closeSettings()">OK</button></div>
            </div></div></div>
        ${editingType ? renderTypeEditModal() : ''}`;
    }

    function renderTypeEditModal() {
      const cfg = { programmes: { hasColor: true, colorType: 'single' }, statuts: { hasColor: true, colorType: 'badge' }, priorites: { hasColor: true, colorType: 'badge' }, fonctions: { hasColor: false }, niveaux: { hasColor: true, colorType: 'badge' } }[editingType];
      const item = editingTypeItem || { nom: '', couleur: '#3B82F6', bgColor: '#DBEAFE', textColor: '#1E40AF' };
      const isNew = !editingTypeItem;
      return `
        <div class="modal-overlay" onclick="closeTypeEdit()"><div class="modal" style="max-width: 400px;" onclick="event.stopPropagation()">
            <div class="modal-header"><span class="modal-title">${isNew ? 'Ajouter' : 'Modifier'}</span><button class="modal-close" onclick="closeTypeEdit()">√ó</button></div>
            <div class="modal-body">
              <div class="form-group" style="margin-bottom:16px"><label class="form-label">Intitul√©</label><input class="form-input" id="type-nom" value="${safe(item.nom)}"></div>
              ${cfg.hasColor && cfg.colorType === 'single' ? `<div class="form-group"><label class="form-label">Couleur</label><input type="color" class="color-input" id="type-couleur" value="${item.couleur || '#3B82F6'}" style="width:100%;height:40px;cursor:pointer"></div>` : ''}
              ${cfg.hasColor && cfg.colorType === 'badge' ? `<div class="form-row" style="display:flex;gap:16px"><div class="form-group" style="flex:1"><label class="form-label">Fond</label><input type="color" class="color-input" id="type-bgColor" value="${item.bgColor || '#DBEAFE'}" style="width:100%;height:40px;cursor:pointer"></div><div class="form-group" style="flex:1"><label class="form-label">Texte</label><input type="color" class="color-input" id="type-textColor" value="${item.textColor || '#1E40AF'}" style="width:100%;height:40px;cursor:pointer"></div></div>` : ''}
              <div class="form-actions"><button class="btn btn-secondary" onclick="closeTypeEdit()">Annuler</button><button class="btn btn-primary" onclick="saveTypeItem()">Valider</button></div>
            </div></div></div>`;
    }

    function renderClearModal() {
        return `
        <div class="modal-overlay" onclick="closeClearModal()"><div class="modal" style="max-width: 450px;" onclick="event.stopPropagation()">
            <div class="modal-header" style="border-bottom:none; padding-bottom:0"><span class="modal-title" style="color:var(--danger)">‚ö†Ô∏è Zone de danger</span><button class="modal-close" onclick="closeClearModal()">√ó</button></div>
            <div class="modal-body" style="text-align:center; padding-top:10px">
              <div style="font-size:40px; margin-bottom:16px">üóëÔ∏è</div><h3 style="color:var(--text-main); margin-bottom:8px">Supprimer toutes les donn√©es ?</h3><p style="color:var(--text-muted); font-size:14px; margin-bottom:24px">Cette action est irr√©versible.</p>
              <div class="form-actions" style="justify-content:center; border-top:none; padding-top:0"><button class="btn btn-secondary" onclick="closeClearModal()">Annuler</button><button class="btn btn-danger" onclick="confirmClear()">Confirmer suppression</button></div>
            </div></div></div>`;
    }

    window.updateTitle = (text) => {
      const t = (text || '').trim() || 'PROJET';
      pageTitle = t;
      try { localStorage.setItem('coffim-page-title-v2', pageTitle); } catch(e) {}
    };
    window.setView = (v) => { currentView = v; render(); };
    window.setSearch = (s) => { filters.search = s; render(); };
    
    window.toggleDropdown = (e, key) => {
        e.stopPropagation();
        openDropdown = openDropdown === key ? null : key;
        render();
    };
    window.toggleFilterVal = (key, val) => {
        const arr = filters[key];
        const idx = arr.indexOf(val);
        if (idx >= 0) arr.splice(idx, 1); else arr.push(val);
        render();
    };
    
    window.moveTypeItem = (key, id, dir) => {
       const arr = types[key];
       const idx = arr.findIndex(i => i.id === id);
       if (idx < 0) return;
       const newIdx = idx + dir;
       if (newIdx < 0 || newIdx >= arr.length) return;
       [arr[idx], arr[newIdx]] = [arr[newIdx], arr[idx]];
       saveTypes(); render();
    };

    window.toggleProgramme = (p) => {
      const i = filters.programme.indexOf(p);
      if (i >= 0) filters.programme.splice(i, 1); else filters.programme.push(p);
      render();
    };
    window.clearFilters = () => { filters = { programme: [], search: '', niveau: [], fonction: [] }; render(); };
    window.toggleSort = (col) => {
      if (sortCol === col) { sortAsc = !sortAsc; } else { sortCol = col; sortAsc = true; }
      render();
    };

    window.openModal = (type, id) => { modalType = type; modalItem = id ? data.find(d => d.id === id) : null; render(); };
    window.closeModal = () => { modalType = null; modalItem = null; render(); };
    window.openClearModal = () => { clearModal = true; render(); };
    window.closeClearModal = () => { clearModal = false; render(); };
    
    window.confirmClear = () => { 
        data = []; types = JSON.parse(JSON.stringify(initialTypes)); updateTitle("PROJET (Importer donn√©es)"); selectedIds.clear();
        saveData(); saveTypes(); clearModal = false; render(); 
    };
    
    window.calculateAuto = () => {
      const nb = parseFloat(document.getElementById('f-nombre').value) || 0;
      const unit = parseFloat(document.getElementById('f-surfUnite').value) || 0;
      const isExt = document.getElementById('f-isExt').checked;
      const total = Math.round(nb * unit * 100) / 100;
      document.getElementById('f-totalCalc').value = unit > 0 ? total : 0;
      if (unit > 0) { if (isExt) { document.getElementById('f-sueExt').value = total; document.getElementById('f-sueInt').value = 0; } else { document.getElementById('f-sueInt').value = total; document.getElementById('f-sueExt').value = 0; } }
    };

    window.duplicateItem = (id) => {
      const original = data.find(d => d.id === id); if (!original) return;
      const newItem = JSON.parse(JSON.stringify(original)); newItem.id = getNextId(data); newItem.local = newItem.local + " (Copie)"; 
      data.push(newItem); saveData(); closeModal();
    };
    
    window.saveItem = (id) => {
      const local = document.getElementById('f-local').value.trim();
      if (!local) { alert('Nom requis'); return; }
      const nb = parseFloat(document.getElementById('f-nombre').value) || 1;
      const unit = parseFloat(document.getElementById('f-surfUnite').value) || 0;
      const isExt = document.getElementById('f-isExt').checked;
      let sInt = parseFloat(document.getElementById('f-sueInt').value) || 0;
      let sExt = parseFloat(document.getElementById('f-sueExt').value) || 0;
      if (unit > 0) { const total = Math.round(nb * unit * 100) / 100; if (isExt) { sExt = total; sInt = 0; } else { sInt = total; sExt = 0; } }
      const item = { programme: document.getElementById('f-programme').value, niveau: document.getElementById('f-niveau').value, fonction: document.getElementById('f-fonction').value, local, nombre: nb, surfUnite: unit || null, isExt: isExt, sueInt: sInt || null, sueExt: sExt || null, details: document.getElementById('f-details').value || null, statut: document.getElementById('f-statut').value || null, priorite: document.getElementById('f-priorite').value || null, action: document.getElementById('f-action').value || null };
      if (id) { const idx = data.findIndex(d => d.id === id); data[idx] = { ...data[idx], ...item }; } else { item.id = getNextId(data); data.push(item); }
      saveData(); closeModal();
    };
    
    window.deleteItem = (id) => { if (confirm('Confirmer suppression ?')) { data = data.filter(d => d.id !== id); saveData(); closeModal(); } };
    window.openSettings = () => { settingsModal = true; render(); };
    window.closeSettings = () => { settingsModal = false; editingType = null; editingTypeItem = null; render(); };
    window.addTypeItem = (typeKey) => { editingType = typeKey; editingTypeItem = null; render(); };
    window.editTypeItem = (typeKey, id) => { editingType = typeKey; editingTypeItem = types[typeKey].find(i => i.id === id); render(); };
    window.deleteTypeItem = (typeKey, id) => {
      const item = types[typeKey].find(i => i.id === id);
      if (data.some(d => d[typeKey.slice(0, -1)] === item.nom)) { alert('Type utilis√©.'); return; }
      if (confirm('Supprimer ?')) { types[typeKey] = types[typeKey].filter(i => i.id !== id); saveTypes(); render(); }
    };
    window.closeTypeEdit = () => { editingType = null; editingTypeItem = null; render(); };
    
    window.saveTypeItem = () => {
      const nom = document.getElementById('type-nom').value.trim();
      if (!nom) return;
      const cfg = editingType === 'programmes' ? 'c' : (['statuts','priorites','niveaux'].includes(editingType) ? 'b' : 'n');
      let newItem = { nom };
      if (cfg === 'c') newItem.couleur = document.getElementById('type-couleur').value;
      if (cfg === 'b') { newItem.bgColor = document.getElementById('type-bgColor').value; newItem.textColor = document.getElementById('type-textColor').value; newItem.couleur = newItem.bgColor; }
      if (editingTypeItem) { 
          const oldName = editingTypeItem.nom; const idx = types[editingType].findIndex(i => i.id === editingTypeItem.id); 
          types[editingType][idx] = { ...types[editingType][idx], ...newItem }; 
          if (oldName !== nom) { const dataKey = editingType.slice(0, -1); let updateCount = 0; data.forEach(d => { if (d[dataKey] === oldName) { d[dataKey] = nom; updateCount++; } }); if(updateCount > 0) saveData(); }
      } else { newItem.id = getNextId(types[editingType]); types[editingType].push(newItem); }
      saveTypes(); closeTypeEdit();
    };
    window.resetTypes = () => { if(confirm('R√©tablir les types par d√©faut ?')) { types = JSON.parse(JSON.stringify(initialTypes)); saveTypes(); render(); } };

    const getFileName = (extension) => {
      const now = new Date();
      const year = now.getFullYear().toString().slice(-2);
      const month = (now.getMonth() + 1).toString().padStart(2, '0');
      const day = now.getDate().toString().padStart(2, '0');
      const hour = now.getHours().toString().padStart(2, '0');
      const minute = now.getMinutes().toString().padStart(2, '0');
      const cleanTitle = (pageTitle || 'PROJET').trim().replace(/[^a-z0-9√†√¢√ß√©√®√™√´√Æ√Ø√¥√ª√π√º√ø√±√¶≈ì]/gi, '-').toUpperCase();
      return `SBA-${cleanTitle}-${year}${month}${day}-${hour}${minute}.${extension}`;
    };

    // --- NOUVELLE FONCTION DE SAUVEGARDE (JSON) ---
    window.downloadJson = () => {
        const payload = { author: "BELLECOUR architectes", data, types, pageTitle };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = getFileName('json'); a.click();
    };

    // --- FONCTION EXPORT CSV SEULE ---
    window.exportCsv = () => {
        const headers = ['ID', 'Programme', 'Niveau', 'Fonction', 'Local', 'Surface Unitaire', 'Ext√©rieur', 'Nombre', 'Surface Utile Int.', 'Surface Utile Ext.', 'D√©tails', 'Statut', 'Priorit√©', 'Action'];
        const csvContent = [ headers.join(';'), ...data.map(d => [ d.id, d.programme, d.niveau, d.fonction, '"' + String(d.local || '').replace(/"/g, '""') + '"', d.surfUnite, d.isExt ? '1' : '0', d.nombre, d.sueInt, d.sueExt, '"' + String(d.details || '').replace(/"/g, '""') + '"', d.statut, d.priorite, '"' + String(d.action || '').replace(/"/g, '""') + '"' ].join(';')) ].join('\n');
        const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = getFileName('csv'); a.click();
    };

    window.exportPdf = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4');
        doc.setFontSize(14); doc.text(`PROGRAMMATION: ${pageTitle}`, 14, 15);
        doc.setFontSize(10); doc.setTextColor(100); doc.text("BELLECOUR architectes", 297 - 14, 15, { align: 'right' }); doc.setTextColor(0); 
        const headers = [['Prog.', 'Niveau', 'Fonction', 'Local', 'S.U.', 'Nb', 'Total Int', 'Total Ext', 'Statut']];
        const rows = data.map(d => [d.programme, d.niveau, d.fonction, d.local, d.surfUnite || '-', d.nombre, d.sueInt || '-', d.sueExt || '-', d.statut || '']);
        doc.autoTable({ head: headers, body: rows, startY: 20, styles: { fontSize: 8 }, headStyles: { fillColor: [59, 130, 246] }, alternateRowStyles: { fillColor: [240, 240, 240] } });
        doc.save(getFileName('pdf'));
    };

    const parseCsv = (text) => {
      const rows = []; let row = []; let cur = ''; let inQuotes = false;
      for (let i = 0; i < text.length; i++) {
        const c = text[i];
        if (inQuotes) { if (c === '"') { if (text[i + 1] === '"') { cur += '"'; i++; } else { inQuotes = false; } } else cur += c; } 
        else { if (c === '"') inQuotes = true; else if (c === ';') { row.push(cur); cur = ''; } else if (c === '\r') continue; else if (c === '\n') { row.push(cur); rows.push(row); row = []; cur = ''; } else cur += c; }
      }
      if (cur.length || row.length) { row.push(cur); rows.push(row); }
      return rows;
    };

    const stablePalette = [ '#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#8B5CF6', '#EC4899', '#06B6D4', '#F97316', '#6366F1', '#84CC16', '#14B8A6', '#D946EF', '#E11D48', '#0EA5E9', '#22C55E', '#EAB308', '#A855F7', '#64748B', '#0284C7', '#7C3AED', '#DB2777', '#EA580C', '#059669', '#475569' ];
    const getStableColor = (str) => { if (!str) return stablePalette[stablePalette.length - 1]; let hash = 0; for (let i = 0; i < str.length; i++) { hash = str.charCodeAt(i) + ((hash << 5) - hash); } const index = Math.abs(hash) % stablePalette.length; return stablePalette[index]; };

    const syncTypesWithData = (incomingData) => {
        const foundProgs = new Set(); const foundNiveaux = new Set(); const foundFonctions = new Set();
        incomingData.forEach(item => { if(item.programme) foundProgs.add(item.programme); if(item.niveau) foundNiveaux.add(item.niveau); if(item.fonction) foundFonctions.add(item.fonction); });
        foundProgs.forEach(nom => { if (!types.programmes.find(p => p.nom === nom)) { types.programmes.push({ id: getNextId(types.programmes), nom: nom, couleur: getStableColor(nom) }); } });
        foundNiveaux.forEach(nom => { if (!types.niveaux.find(n => n.nom === nom)) { types.niveaux.push({ id: getNextId(types.niveaux), nom: nom, bgColor: '#F1F5F9', textColor: '#334155' }); } });
        foundFonctions.forEach(nom => { if (!types.fonctions.find(f => f.nom === nom)) { types.fonctions.push({ id: getNextId(types.fonctions), nom: nom }); } });
        saveTypes();
    };

    window.importData = () => {
      const input = document.createElement('input'); input.type = 'file'; input.accept = '.json,.csv';
      input.onchange = (e) => {
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const text = reader.result;
            const isJson = file.name.toLowerCase().endsWith('.json') || text.trim().startsWith('{');
            let newData = null;
            if (isJson) { const json = JSON.parse(text); if (json.data) { newData = json.data; if (json.types) types = json.types; } } 
            else {
                const rows = parseCsv(text);
                if (rows.length > 1) {
                    newData = rows.slice(1).map(cols => ({
                        id: parseInt(cols[0]) || 0,
                        programme: cols[1]?.trim() || "INCONNU", niveau: cols[2]?.trim() || "INCONNU", fonction: cols[3]?.trim() || "INCONNU", local: cols[4],
                        surfUnite: cols[5] ? parseFloat(cols[5].replace(',', '.')) : null, isExt: cols[6] === '1' || cols[6] === 'true',
                        nombre: parseFloat(cols[7]) || 1, sueInt: cols[8] ? parseFloat(cols[8].replace(',', '.')) : null, sueExt: cols[9] ? parseFloat(cols[9].replace(',', '.')) : null,
                        details: cols[10], statut: cols[11], priorite: cols[12], action: cols[13]
                    })).filter(d => d.local);
                }
            }
            if(newData) { 
                if(confirm('Remplacer les donn√©es actuelles par ce fichier ?')) { 
                    data = newData; syncTypesWithData(data);
                    let fileName = file.name.replace(/\.[^/.]+$/, ""); 
                    if (fileName.toUpperCase().startsWith("SBA-")) { fileName = fileName.substring(4); }
                    fileName = fileName.replace(/-\d{6}-\d{4}$/, "");
                    updateTitle(fileName.replace(/-/g, " ").trim());
                    saveData(); render(); 
                }
            } else { alert('Format non reconnu'); }
          } catch(e) { console.error(e); alert('Erreur Import : ' + e.message); }
        };
        reader.readAsText(file);
      };
      input.click();
    };
    
    // Garder cette fonction au cas o√π vous voudriez sauvegarder le fichier HTML complet, mais elle n'est plus li√©e au bouton principal
    window.saveHtml = () => {
        const html = document.documentElement.outerHTML;
        const typesJson = JSON.stringify(types, null, 2);
        const dataJson = JSON.stringify(data, null, 2);
        const titleJson = JSON.stringify(pageTitle);
        const r = (src, start, end, newContent) => { const s = src.indexOf(start); const e = src.indexOf(end); return (s > -1 && e > -1) ? src.slice(0, s) + newContent + src.slice(e + end.length) : src; };
        let out = html;
        out = r(out, '// __TYPES_START__', '// __TYPES_END__', `// __TYPES_START__\n    const initialTypes = ${typesJson};\n// __TYPES_END__`);
        out = r(out, '// __DATA_START__', '// __DATA_END__', `// __DATA_START__\n    const initialData = ${dataJson};\n// __DATA_END__`);
        out = r(out, '    let pageTitle = safeGetItem(\'coffim-page-title-v2\') || "PROJET (Importer donn√©es)";', '    let types = JSON.parse(safeGetItem(\'coffim-alve-types-v2\')) || JSON.parse(JSON.stringify(initialTypes));', `    let pageTitle = ${titleJson};\n    let data = JSON.parse(safeGetItem('coffim-alve-data-v2')) || JSON.parse(JSON.stringify(initialData));\n    let types = JSON.parse(safeGetItem('coffim-alve-types-v2')) || JSON.parse(JSON.stringify(initialTypes));`);
        const blob = new Blob(['<!DOCTYPE html>\n' + out], { type: 'text/html;charset=utf-8' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = getFileName('html'); a.click();
    };

    window.resetData = () => { if(confirm('R√©initialiser toutes les donn√©es ?')) { data = JSON.parse(JSON.stringify(initialData)); saveData(); render(); } };

    render();
  </script>
</body></html>
