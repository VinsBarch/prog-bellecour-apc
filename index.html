<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="PROJET">
  <title>PROGRAMMATION V7.0 (Robust)</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* --- DESIGN SYSTEM V7.0 --- */
    :root {
      --bg-body: #0F172A; --bg-card: #1E293B; --bg-input: #0F172A;
      --bg-hover: #334155; --border-color: #334155;
      --text-main: #F1F5F9; --text-muted: #94A3B8; --text-inv: #0F172A;
      --primary: #3B82F6; --primary-hover: #2563EB;
      --success: #10B981; --danger: #EF4444; --warning: #F59E0B;
      --accent: #8B5CF6;
      --radius: 12px;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.1);
    }
    :root.light {
      --bg-body: #F8FAFC; --bg-card: #FFFFFF; --bg-input: #F1F5F9;
      --bg-hover: #E2E8F0; --border-color: #CBD5E1;
      --text-main: #0F172A; --text-muted: #64748B; --text-inv: #FFFFFF;
      --primary: #2563EB;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
    body { background: var(--bg-body); color: var(--text-main); padding: 20px; padding-bottom: 120px; font-size: 14px; max-width: 1600px; margin: 0 auto; transition: background 0.3s, color 0.3s; }
    
    /* UTILS */
    .hidden { display: none !important; }
    .btn { height: 40px; padding: 0 16px; border-radius: 8px; font-weight: 600; cursor: pointer; border: 1px solid transparent; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; transition: all 0.2s; }
    .btn:active { transform: scale(0.98); }
    .btn-primary { background: var(--primary); color: white; }
    .btn-secondary { background: var(--bg-card); border-color: var(--border-color); color: var(--text-main); }
    .btn-secondary:hover { background: var(--bg-hover); }
    .btn-danger { background: rgba(239,68,68,0.1); color: var(--danger); border-color: transparent; }
    .btn-icon { width: 40px; padding: 0; font-size: 18px; }

    /* LAYOUT */
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color); }
    .header-title { font-size: 24px; font-weight: 800; }
    .header-subtitle { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }

    .toolbar { display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; }
    .spacer { flex: 1; }

    /* STATS */
    .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 30px; }
    .stat-card { background: var(--bg-card); padding: 20px; border-radius: var(--radius); border: 1px solid var(--border-color); }
    .stat-label { font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px; }
    .stat-value { font-size: 28px; font-weight: 800; }

    /* FILTERS AREA */
    .filters-wrapper { background: var(--bg-card); padding: 20px; border-radius: var(--radius); border: 1px solid var(--border-color); margin-bottom: 24px; }
    .search-grid { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 12px; margin-bottom: 16px; }
    @media(max-width:768px){ .search-grid { grid-template-columns: 1fr; } }
    
    .input-field { width: 100%; height: 42px; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 8px; padding: 0 12px; color: var(--text-main); font-size: 14px; }
    .input-field:focus { outline: none; border-color: var(--primary); }
    
    .chip-list { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .chip { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; cursor: pointer; border: 1px solid var(--border-color); background: var(--bg-card); color: var(--text-muted); transition: all 0.2s; }
    .chip.active { color: white; border-color: transparent; }

    /* TABLE */
    .table-container { background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border-color); overflow: hidden; }
    .main-table { width: 100%; border-collapse: collapse; }
    .main-table th { background: var(--bg-input); padding: 14px 12px; text-align: left; font-size: 11px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; border-bottom: 1px solid var(--border-color); cursor: pointer; user-select: none; }
    .main-table td { padding: 12px; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
    .main-table tbody tr:hover { background: var(--bg-hover); cursor: pointer; }
    .badge { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; }
    
    /* MODALS */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 1000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
    .modal-backdrop.open { opacity: 1; pointer-events: auto; }
    .modal-content { background: var(--bg-card); width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; border-radius: 20px; border: 1px solid var(--border-color); box-shadow: 0 20px 50px rgba(0,0,0,0.5); transform: translateY(20px); transition: transform 0.2s; }
    .modal-backdrop.open .modal-content { transform: translateY(0); }
    .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; font-weight: 700; font-size: 18px; }
    .modal-body { padding: 24px; }
    
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
    .form-group { margin-bottom: 16px; }
    .form-group.span-2 { grid-column: span 2; }
    .form-label { display: block; font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-bottom: 6px; }

    /* TOASTS */
    #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
    .toast { background: var(--bg-card); padding: 12px 20px; border-radius: 8px; border-left: 4px solid var(--primary); box-shadow: 0 5px 15px rgba(0,0,0,0.3); font-weight: 500; animation: slideIn 0.3s; display: flex; align-items: center; gap: 10px;}
    @keyframes slideIn { from{transform: translateX(100%)} to{transform: translateX(0)} }
    
    /* Utility colors */
    .text-right { text-align: right; }
    .text-center { text-align: center; }
  </style>
</head>
<body>

  <div class="header">
    <div>
      <div id="app-title" class="header-title" contenteditable="true">PROJET</div>
      <div class="header-subtitle">Programmation V7.0 (Robust)</div>
    </div>
    <button class="btn btn-secondary btn-icon" id="btn-theme">â˜¼</button>
  </div>

  <div class="toolbar">
    <button class="btn btn-secondary btn-icon" id="btn-lock">ðŸ”“</button>
    <button class="btn btn-secondary" id="btn-undo" disabled>â†© Annuler</button>
    <div class="spacer"></div>
    <button class="btn btn-primary" id="btn-save">ðŸ’¾ Sauvegarder</button>
    <button class="btn btn-secondary" id="btn-export">Export CSV</button>
    <button class="btn btn-secondary" id="btn-import">Import</button>
    <button class="btn btn-danger" id="btn-clear">Effacer</button>
  </div>

  <div class="stats-container" id="stats-area">
    </div>

  <div class="filters-wrapper">
    <div class="search-grid">
      <input type="text" id="inp-search" class="input-field" placeholder="Rechercher un local...">
      <select id="sel-niveau" class="input-field"><option value="">Tous Niveaux</option></select>
      <select id="sel-fonction" class="input-field"><option value="">Toutes Fonctions</option></select>
    </div>
    <div class="chip-list" id="prog-chips">
      </div>
    <div style="margin-top: 12px; padding-top:12px; border-top: 1px solid var(--border-color); display:flex; gap:10px;">
       <button class="btn btn-secondary" id="btn-add-item">âž• Ajouter Local</button>
       <div class="spacer"></div>
       <button class="btn btn-secondary btn-icon" id="btn-reset-filters" title="Reset filtres">âœ•</button>
    </div>
  </div>

  <div class="table-container">
    <table class="main-table">
      <thead>
        <tr>
          <th data-sort="programme">Programme</th>
          <th data-sort="niveau">Niveau</th>
          <th data-sort="fonction">Fonction</th>
          <th data-sort="local">Local</th>
          <th class="text-right" data-sort="surfUnite">S.U.</th>
          <th class="text-center" data-sort="nombre">Nbr</th>
          <th class="text-right" data-sort="sueInt">Total Int.</th>
          <th class="text-right" data-sort="sueExt">Total Ext.</th>
          <th data-sort="statut">Statut</th>
        </tr>
      </thead>
      <tbody id="table-body">
        </tbody>
      <tfoot id="table-foot">
         </tfoot>
    </table>
  </div>

  <div class="footer-legal" style="margin-top: 40px; text-align:center; opacity:0.5; font-size:12px;">BELLECOUR architectes - PropriÃ©tÃ© exclusive</div>

  <div class="modal-backdrop" id="modal-item">
    <div class="modal-content">
      <div class="modal-header">
        <span id="modal-title">Ã‰diter</span>
        <button class="btn btn-secondary btn-icon" onclick="App.ui.closeModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <form id="form-item" onsubmit="event.preventDefault(); App.methods.saveForm();">
          <input type="hidden" id="f-id">
          <div class="form-row">
             <div class="form-group"><label class="form-label">Programme</label><select id="f-programme" class="input-field" required></select></div>
             <div class="form-group"><label class="form-label">Niveau</label><select id="f-niveau" class="input-field" required></select></div>
          </div>
          <div class="form-group"><label class="form-label">Fonction</label><select id="f-fonction" class="input-field"></select></div>
          <div class="form-group"><label class="form-label">Nom du local</label><input type="text" id="f-local" class="input-field" required></div>
          
          <div class="form-row">
            <div class="form-group"><label class="form-label">S.U. (mÂ²)</label><input type="number" step="0.01" id="f-surf" class="input-field"></div>
            <div class="form-group"><label class="form-label">Nombre</label><input type="number" step="1" id="f-nbr" class="input-field" value="1"></div>
          </div>
          <div class="form-group"><label class="form-label" style="display:flex; align-items:center; gap:8px;"><input type="checkbox" id="f-isExt"> Est en ExtÃ©rieur ?</label></div>

          <div class="form-group"><label class="form-label">Statut</label><select id="f-statut" class="input-field"></select></div>
          <div class="form-group"><label class="form-label">Remarques</label><textarea id="f-remarque" class="input-field" style="height:60px; padding-top:8px;"></textarea></div>

          <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
             <button type="button" class="btn btn-danger" id="btn-delete-item">Supprimer</button>
             <button type="button" class="btn btn-secondary" onclick="App.ui.closeModal()">Annuler</button>
             <button type="submit" class="btn btn-primary">Enregistrer</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div id="toast-container"></div>

  <script>
    /* =========================================
       1. CONFIGURATION & DONNEES PAR DEFAUT
       ========================================= */
    const CONFIG = {
      types: {
        programmes: [
           { nom: "BUREAUX", couleur: "#3B82F6" },
           { nom: "LOGEMENTS", couleur: "#10B981" },
           { nom: "COMMERCES", couleur: "#F59E0B" },
           { nom: "COMMUNS", couleur: "#64748B" }
        ],
        niveaux: [ {nom:"R-1"}, {nom:"RDC"}, {nom:"R+1"}, {nom:"R+2"}, {nom:"R+3"}, {nom:"TOITURE"} ],
        fonctions: [ {nom:"Circulation"}, {nom:"Travail"}, {nom:"Sanitaire"}, {nom:"Technique"}, {nom:"Stockage"} ],
        statuts: [
           { nom: "Ã€ CONFIRMER", bg: "#FFFBEB", txt: "#B45309" },
           { nom: "VALIDÃ‰", bg: "#ECFDF5", txt: "#047857" },
           { nom: "MODIFIÃ‰", bg: "#EFF6FF", txt: "#1D4ED8" },
           { nom: "MANQUANT", bg: "#FEF2F2", txt: "#B91C1C" }
        ]
      }
    };

    /* =========================================
       2. GESTION DE L'ETAT (STATE MANAGEMENT)
       ========================================= */
    const App = {
      state: {
        data: [],
        title: "PROJET",
        filters: { search: "", programme: [], niveau: "", fonction: "" },
        sort: { col: "programme", asc: true },
        locked: false,
        history: [],
        types: JSON.parse(JSON.stringify(CONFIG.types)) // Copie profonde
      },

      /* =========================================
         3. INITIALISATION
         ========================================= */
      init: () => {
        // Chargement LocalStorage
        const savedData = localStorage.getItem('v7-data');
        const savedTitle = localStorage.getItem('v7-title');
        if(savedData) App.state.data = JSON.parse(savedData);
        if(savedTitle) App.state.title = savedTitle;
        
        // Initialisation UI
        document.getElementById('app-title').innerText = App.state.title;
        if(localStorage.getItem('v7-theme') === 'light') document.body.classList.add('light');

        // Render initial
        App.render.initSelects();
        App.render.chips();
        App.render.table();
        App.render.stats();
        
        // Bind Events
        App.events.bindAll();
      },

      /* =========================================
         4. METHODES DE LOGIQUE (CRUD)
         ========================================= */
      methods: {
        save: () => {
          localStorage.setItem('v7-data', JSON.stringify(App.state.data));
          localStorage.setItem('v7-title', App.state.title);
          App.ui.toast("Sauvegarde effectuÃ©e");
        },
        pushHistory: () => {
          if(App.state.history.length > 10) App.state.history.shift();
          App.state.history.push(JSON.stringify(App.state.data));
          document.getElementById('btn-undo').disabled = false;
        },
        undo: () => {
          if(App.state.history.length === 0) return;
          App.state.data = JSON.parse(App.state.history.pop());
          if(App.state.history.length === 0) document.getElementById('btn-undo').disabled = true;
          App.methods.save();
          App.render.table();
          App.render.stats();
          App.ui.toast("Annulation effectuÃ©e");
        },
        
        // CRUD Item
        addItem: () => {
          App.ui.openModal();
        },
        editItem: (id) => {
          const item = App.state.data.find(i => i.id === id);
          if(item) App.ui.openModal(item);
        },
        deleteItem: (id) => {
          if(confirm("Supprimer ce local ?")) {
            App.methods.pushHistory();
            App.state.data = App.state.data.filter(i => i.id !== id);
            App.methods.save();
            App.ui.closeModal();
            App.render.table();
            App.render.stats();
          }
        },
        saveForm: () => {
          const id = document.getElementById('f-id').value;
          const formData = {
             programme: document.getElementById('f-programme').value,
             niveau: document.getElementById('f-niveau').value,
             fonction: document.getElementById('f-fonction').value,
             local: document.getElementById('f-local').value,
             surfUnite: parseFloat(document.getElementById('f-surf').value) || 0,
             nombre: parseFloat(document.getElementById('f-nbr').value) || 1,
             isExt: document.getElementById('f-isExt').checked,
             statut: document.getElementById('f-statut').value,
             remarque: document.getElementById('f-remarque').value
          };
          
          // Calcul Auto
          const total = Math.round(formData.surfUnite * formData.nombre * 100) / 100;
          formData.sueInt = formData.isExt ? 0 : total;
          formData.sueExt = formData.isExt ? total : 0;

          App.methods.pushHistory();

          if(id) {
            // Edit
            const idx = App.state.data.findIndex(i => i.id == id);
            if(idx >= 0) App.state.data[idx] = { ...App.state.data[idx], ...formData };
          } else {
            // Create
            formData.id = Date.now();
            App.state.data.push(formData);
          }
          
          App.methods.save();
          App.ui.closeModal();
          App.render.table();
          App.render.stats();
        },
        
        clearAll: () => {
           if(confirm("Tout effacer ? Cette action est irrÃ©versible.")) {
               App.methods.pushHistory();
               App.state.data = [];
               App.methods.save();
               App.render.table();
               App.render.stats();
           }
        }
      },

      /* =========================================
         5. RENDU DOM (OptimisÃ©, pas de innerHTML global)
         ========================================= */
      render: {
        initSelects: () => {
          // Remplit les selects filtres et modal une fois pour toutes
          const fill = (id, list) => {
            const el = document.getElementById(id);
            // Garder la premiÃ¨re option si c'est un filtre
            const start = el.options.length > 0 ? 1 : 0;
            // Nettoyer sauf le default
            while(el.options.length > start) el.remove(start);
            list.forEach(item => {
              const opt = document.createElement('option');
              opt.value = item.nom;
              opt.innerText = item.nom;
              el.appendChild(opt);
            });
          };
          
          // Filtres
          fill('sel-niveau', App.state.types.niveaux);
          fill('sel-fonction', App.state.types.fonctions);
          
          // Formulaire
          fill('f-programme', App.state.types.programmes);
          fill('f-niveau', App.state.types.niveaux);
          fill('f-fonction', App.state.types.fonctions);
          fill('f-statut', App.state.types.statuts);
        },

        chips: () => {
          const container = document.getElementById('prog-chips');
          container.innerHTML = '';
          App.state.types.programmes.forEach(p => {
             const btn = document.createElement('button');
             btn.className = `chip ${App.state.filters.programme.includes(p.nom) ? 'active' : ''}`;
             btn.innerText = p.nom;
             if(btn.classList.contains('active')) btn.style.backgroundColor = p.couleur;
             else btn.style.borderColor = p.couleur;
             
             btn.onclick = () => {
                const idx = App.state.filters.programme.indexOf(p.nom);
                if(idx > -1) App.state.filters.programme.splice(idx, 1);
                else App.state.filters.programme.push(p.nom);
                App.render.chips();
                App.render.table();
                App.render.stats();
             };
             container.appendChild(btn);
          });
        },

        table: () => {
          const tbody = document.getElementById('table-body');
          const tfoot = document.getElementById('table-foot');
          tbody.innerHTML = ''; 

          // Filtrage
          const f = App.state.filters;
          let filtered = App.state.data.filter(d => {
             if(f.search && !d.local.toLowerCase().includes(f.search.toLowerCase())) return false;
             if(f.programme.length && !f.programme.includes(d.programme)) return false;
             if(f.niveau && d.niveau !== f.niveau) return false;
             if(f.fonction && d.fonction !== f.fonction) return false;
             return true;
          });

          // Tri
          const col = App.state.sort.col;
          const asc = App.state.sort.asc;
          filtered.sort((a, b) => {
             let va = a[col], vb = b[col];
             if(typeof va === 'string') return asc ? va.localeCompare(vb) : vb.localeCompare(va);
             return asc ? va - vb : vb - va;
          });

          // Rendu Lignes
          if(filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="text-center" style="padding:40px; color:var(--text-muted)">Aucun rÃ©sultat</td></tr>';
          } else {
             const fragment = document.createDocumentFragment();
             filtered.forEach(item => {
                const tr = document.createElement('tr');
                tr.onclick = () => { if(!App.state.locked) App.methods.editItem(item.id); };
                
                // Styles couleurs
                const progColor = App.state.types.programmes.find(p=>p.nom===item.programme)?.couleur || '#888';
                const stConf = App.state.types.statuts.find(s=>s.nom===item.statut);
                const stStyle = stConf ? `background:${stConf.bg}; color:${stConf.txt}` : '';

                tr.innerHTML = `
                  <td style="color:${progColor}; font-weight:600">${item.programme}</td>
                  <td><span class="badge" style="background:var(--bg-input)">${item.niveau}</span></td>
                  <td>${item.fonction || '-'}</td>
                  <td><strong>${item.local}</strong></td>
                  <td class="text-right">${item.surfUnite || '-'}</td>
                  <td class="text-center">${item.nombre}</td>
                  <td class="text-right" style="color:${item.sueInt ? 'var(--primary)' : 'inherit'}; font-weight:700">${item.sueInt||'-'}</td>
                  <td class="text-right" style="color:${item.sueExt ? 'var(--success)' : 'inherit'}; font-weight:700">${item.sueExt||'-'}</td>
                  <td>${item.statut ? `<span class="badge" style="${stStyle}">${item.statut}</span>` : ''}</td>
                `;
                fragment.appendChild(tr);
             });
             tbody.appendChild(fragment);
          }
          
          // Rendu Footer (Totaux)
          const sumInt = filtered.reduce((a,b)=> a+(b.sueInt||0), 0);
          const sumExt = filtered.reduce((a,b)=> a+(b.sueExt||0), 0);
          tfoot.innerHTML = `<tr><td colspan="6" class="text-right"><strong>TOTAUX VISIBLES</strong></td><td class="text-right"><strong>${sumInt.toLocaleString()} mÂ²</strong></td><td class="text-right"><strong>${sumExt.toLocaleString()} mÂ²</strong></td><td></td></tr>`;
        },

        stats: () => {
          const container = document.getElementById('stats-area');
          const totalInt = App.state.data.reduce((a,b)=> a+(b.sueInt||0), 0);
          const totalExt = App.state.data.reduce((a,b)=> a+(b.sueExt||0), 0);
          
          container.innerHTML = `
            <div class="stat-card" style="border-left:4px solid var(--primary)">
               <div class="stat-label">Total IntÃ©rieur</div>
               <div class="stat-value" style="color:var(--primary)">${totalInt.toLocaleString()} <span style="font-size:14px">mÂ²</span></div>
            </div>
            <div class="stat-card" style="border-left:4px solid var(--success)">
               <div class="stat-label">Total ExtÃ©rieur</div>
               <div class="stat-value" style="color:var(--success)">${totalExt.toLocaleString()} <span style="font-size:14px">mÂ²</span></div>
            </div>
             <div class="stat-card">
               <div class="stat-label">Nombre de Locaux</div>
               <div class="stat-value">${App.state.data.length}</div>
            </div>
          `;
        }
      },

      /* =========================================
         6. GESTION UI & EVENTS
         ========================================= */
      ui: {
        toast: (msg) => {
           const div = document.createElement('div');
           div.className = 'toast';
           div.innerText = msg;
           document.getElementById('toast-container').appendChild(div);
           setTimeout(() => div.remove(), 3000);
        },
        openModal: (item = null) => {
           const modal = document.getElementById('modal-item');
           const form = document.getElementById('form-item');
           form.reset();
           document.getElementById('f-id').value = '';
           document.getElementById('btn-delete-item').style.display = 'none';

           if(item) {
             document.getElementById('modal-title').innerText = "Modifier Local";
             document.getElementById('f-id').value = item.id;
             document.getElementById('f-programme').value = item.programme;
             document.getElementById('f-niveau').value = item.niveau;
             document.getElementById('f-fonction').value = item.fonction;
             document.getElementById('f-local').value = item.local;
             document.getElementById('f-surf').value = item.surfUnite;
             document.getElementById('f-nbr').value = item.nombre;
             document.getElementById('f-isExt').checked = item.isExt;
             document.getElementById('f-statut').value = item.statut;
             document.getElementById('f-remarque').value = item.remarque || '';
             document.getElementById('btn-delete-item').style.display = 'block';
             document.getElementById('btn-delete-item').onclick = () => App.methods.deleteItem(item.id);
           } else {
             document.getElementById('modal-title').innerText = "Nouveau Local";
           }
           modal.classList.add('open');
        },
        closeModal: () => {
           document.getElementById('modal-item').classList.remove('open');
        }
      },

      events: {
        bindAll: () => {
          // Theme
          document.getElementById('btn-theme').onclick = () => {
             document.body.classList.toggle('light');
             localStorage.setItem('v7-theme', document.body.classList.contains('light')?'light':'dark');
          };
          
          // Lock
          document.getElementById('btn-lock').onclick = () => {
             App.state.locked = !App.state.locked;
             document.getElementById('btn-lock').innerText = App.state.locked ? 'ðŸ”’' : 'ðŸ”“';
             App.ui.toast(App.state.locked ? "Mode Lecture Seule" : "Mode Ã‰dition");
          };

          // Filtres (Input Search : Pas de re-render global !)
          document.getElementById('inp-search').oninput = (e) => {
             App.state.filters.search = e.target.value;
             App.render.table();
          };
          document.getElementById('sel-niveau').onchange = (e) => {
             App.state.filters.niveau = e.target.value;
             App.render.table();
          };
          document.getElementById('sel-fonction').onchange = (e) => {
             App.state.filters.fonction = e.target.value;
             App.render.table();
          };
          document.getElementById('btn-reset-filters').onclick = () => {
             App.state.filters = { search: "", programme: [], niveau: "", fonction: "" };
             document.getElementById('inp-search').value = "";
             document.getElementById('sel-niveau').value = "";
             document.getElementById('sel-fonction').value = "";
             App.render.chips();
             App.render.table();
          };

          // CRUD Buttons
          document.getElementById('btn-add-item').onclick = App.methods.addItem;
          document.getElementById('btn-save').onclick = App.methods.save;
          document.getElementById('btn-clear').onclick = App.methods.clearAll;
          document.getElementById('btn-undo').onclick = App.methods.undo;

          // Title Edit
          document.getElementById('app-title').onblur = (e) => {
             App.state.title = e.target.innerText;
             App.methods.save();
          };
          
          // Sort
          document.querySelectorAll('th[data-sort]').forEach(th => {
             th.onclick = () => {
                const col = th.dataset.sort;
                if(App.state.sort.col === col) App.state.sort.asc = !App.state.sort.asc;
                else { App.state.sort.col = col; App.state.sort.asc = true; }
                App.render.table();
             };
          });
        }
      }
    };

    // START
    window.addEventListener('DOMContentLoaded', App.init);

  </script>
</body>
</html>
