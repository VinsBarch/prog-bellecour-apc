<!DOCTYPE html>
<html lang="fr"><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>APP FRAMEWORK V7</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
  <style>
    /* --- CORE CSS (DESIGN SYSTEM) --- */
    :root { --bg: #0F172A; --card: #1E293B; --input: #0F172A; --text: #F1F5F9; --muted: #94A3B8; --primary: #3B82F6; --success: #10B981; --danger: #EF4444; --accent: #8B5CF6; --border: #334155; }
    :root.light { --bg: #F8FAFC; --card: #FFFFFF; --input: #F1F5F9; --text: #0F172A; --muted: #64748B; --primary: #2563EB; --border: #CBD5E1; }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
    body { background: var(--bg); color: var(--text); padding: 20px; font-size: 14px; padding-bottom: 100px; max-width: 1600px; margin: 0 auto; transition: 0.3s; }
    
    /* Layout */
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
    .app-title { font-size: 24px; font-weight: 800; }
    .toolbar { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; align-items: center; }
    
    /* UI Components */
    .btn { height: 40px; padding: 0 16px; border-radius: 8px; border: 1px solid transparent; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; background: var(--card); color: var(--text); border-color: var(--border); transition: 0.2s; }
    .btn:hover { background: var(--border); }
    .btn-primary { background: var(--primary); color: white; border: none; } .btn-primary:hover { filter: brightness(1.1); }
    .btn-success { background: var(--success); color: white; border: none; }
    .btn-danger { color: var(--danger); background: rgba(239,68,68,0.1); border-color: rgba(239,68,68,0.3); }
    
    /* Table */
    .table-container { background: var(--card); border-radius: 12px; border: 1px solid var(--border); overflow: auto; max-height: 70vh; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    table { width: 100%; border-collapse: collapse; white-space: nowrap; }
    th { text-align: left; padding: 14px 12px; background: var(--input); color: var(--muted); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; position: sticky; top: 0; z-index: 10; cursor: pointer; user-select: none; }
    th:hover { color: var(--text); }
    td { padding: 12px; border-bottom: 1px solid var(--border); }
    tr:hover td { background: var(--bg); }
    tfoot td { position: sticky; bottom: 0; background: var(--input); font-weight: bold; border-top: 2px solid var(--border); }
    
    /* Badges & Chips */
    .badge { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; }
    .chip { padding: 6px 12px; border-radius: 20px; background: var(--card); border: 1px solid var(--border); font-size: 12px; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; }
    .chip.active { background: var(--primary); color: white; border-color: var(--primary); }
    
    /* Forms & Inputs */
    .search-box { width: 100%; max-width: 300px; padding: 10px 14px; border-radius: 8px; border: 1px solid var(--border); background: var(--input); color: var(--text); }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(4px); }
    .modal { background: var(--card); padding: 30px; border-radius: 16px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); border: 1px solid var(--border); }
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 12px; font-weight: 700; color: var(--muted); margin-bottom: 6px; text-transform: uppercase; }
    .form-control { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--input); color: var(--text); }
    .form-control:focus { outline: 2px solid var(--primary); border-color: transparent; }
    
    /* Utilities */
    .hidden { display: none; }
    .text-right { text-align: right; }
    .text-center { text-align: center; }
    .highlight { background: rgba(253, 224, 71, 0.3); color: var(--text); padding: 0 2px; border-radius: 2px; }
    .toast { position: fixed; bottom: 20px; right: 20px; background: var(--card); border: 1px solid var(--border); padding: 12px 20px; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-left: 4px solid var(--success); animation: slideIn 0.3s; z-index: 2000; }
    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
  </style>
</head>
<body>

<script>
const APP_DEF = {
    title: "PROGRAMMATION", // Nom de l'app
    storageKey: "coffim-app-v7",
    
    // DÃ©finition des listes de choix (Dropdowns)
    lists: {
        programmes: [], // Sera rempli dynamiquement ou par dÃ©faut
        niveaux: [ {id:1, nom:"RDC"}, {id:2, nom:"R+1"}, {id:3, nom:"R+2"}, {id:4, nom:"Sous-sol"} ],
        fonctions: [ {id:1, nom:"Circulation"}, {id:2, nom:"Bureau"}, {id:3, nom:"Technique"}, {id:4, nom:"Sanitaire"} ],
        statuts: [ {id:1, nom:"Ã€ FAIRE", color:"#F59E0B"}, {id:2, nom:"VALIDÃ‰", color:"#10B981"}, {id:3, nom:"EN COURS", color:"#3B82F6"} ],
        priorites: [ {id:1, nom:"HAUTE", color:"#EF4444"}, {id:2, nom:"MOYENNE", color:"#F59E0B"}, {id:3, nom:"BASSE", color:"#10B981"} ]
    },

    // DÃ©finition des colonnes (Le cÅ“ur du framework)
    // type: 'text', 'number', 'select', 'bool', 'textarea'
    // width: largeur CSS
    // summary: 'sum' (somme), 'count' (compteur)
    fields: [
        { key: 'programme', label: 'Programme', type: 'select', list: 'programmes', width: '120px', color: true, filter: true },
        { key: 'niveau',    label: 'Niveau',    type: 'select', list: 'niveaux',    width: '80px',  badge: true, filter: true },
        { key: 'fonction',  label: 'Fonction',  type: 'select', list: 'fonctions',  width: '100px', badge: true, filter: true },
        { key: 'local',     label: 'Local',     type: 'text',   width: '200px',     main: true,     required: true, search: true }, // 'main' = texte principal
        { key: 'surfUnite', label: 'S.U. (mÂ²)', type: 'number', width: '80px',      align: 'right', summary: 'sum', calcTrigger: true },
        { key: 'nombre',    label: 'QtÃ©',       type: 'number', width: '60px',      align: 'center', summary: 'sum', calcTrigger: true, default: 1 },
        { key: 'isExt',     label: 'Ext.',      type: 'bool',   width: '50px',      align: 'center', calcTrigger: true },
        
        // Champs calculÃ©s (readOnly)
        { key: 'sueInt',    label: 'Total Int', type: 'number', width: '90px',      align: 'right', summary: 'sum', readOnly: true, style: 'font-weight:bold; color:var(--primary)' },
        { key: 'sueExt',    label: 'Total Ext', type: 'number', width: '90px',      align: 'right', summary: 'sum', readOnly: true, style: 'font-weight:bold; color:var(--success)' },
        
        { key: 'statut',    label: 'Statut',    type: 'select', list: 'statuts',    width: '100px', badge: true },
        { key: 'remarque',  label: 'Remarques', type: 'textarea', width: '200px' }
    ],

    // Logique de calcul spÃ©cifique (Hooks)
    hooks: {
        // AppelÃ© Ã  chaque changement de valeur dans le formulaire
        onCalculate: (item) => {
            const unit = parseFloat(item.surfUnite) || 0;
            const nb = parseFloat(item.nombre) || 1;
            const total = Math.round(unit * nb * 100) / 100;
            
            if (item.isExt) {
                item.sueExt = total;
                item.sueInt = 0;
            } else {
                item.sueInt = total;
                item.sueExt = 0;
            }
            return item;
        },
        // Pour gÃ©nÃ©rer des couleurs automatiques
        getColor: (str) => {
            const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899'];
            let hash = 0;
            for (let i=0; i<str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            return colors[Math.abs(hash) % colors.length];
        }
    }
};
</script>


<div id="app"></div>

<script>
// --- STATE MANAGEMENT ---
let data = [];
let lists = JSON.parse(JSON.stringify(APP_DEF.lists)); // Clone
let filters = {}; // Dynamic filters based on config
let searchQuery = "";
let historyStack = [];
let editingId = null;

// --- INIT ---
function init() {
    // Load Data
    const savedData = localStorage.getItem(APP_DEF.storageKey + '_data');
    const savedLists = localStorage.getItem(APP_DEF.storageKey + '_lists');
    if (savedData) data = JSON.parse(savedData);
    if (savedLists) lists = JSON.parse(savedLists);
    
    renderApp();
}

// --- CORE RENDERING ---
function renderApp() {
    const app = document.getElementById('app');
    
    // 1. Prepare Data
    let filteredData = data.filter(item => {
        if (searchQuery && !Object.values(item).some(v => String(v).toLowerCase().includes(searchQuery.toLowerCase()))) return false;
        for (const [key, values] of Object.entries(filters)) {
            if (values.length > 0 && !values.includes(item[key])) return false;
        }
        return true;
    });

    // 2. Generate HTML
    let html = `
        <div class="header">
            <div class="app-title">${APP_DEF.title}</div>
            <div>
                <button class="btn" onclick="toggleTheme()">ðŸŒ— ThÃ¨me</button>
            </div>
        </div>

        <div class="toolbar">
            <button class="btn btn-primary" onclick="openModal()">âž• Nouveau</button>
            <button class="btn" onclick="undo()" ${historyStack.length===0?'disabled':''}>â†© Annuler</button>
            <button class="btn" onclick="exportCSV()">ðŸ“„ Export CSV</button>
            <div class="spacer" style="flex:1"></div>
            <input type="text" class="search-box" placeholder="Rechercher..." value="${searchQuery}" oninput="setSearch(this.value)">
        </div>

        <div class="toolbar">
            ${APP_DEF.fields.filter(f => f.filter).map(f => {
                const activeCount = filters[f.key]?.length || 0;
                return `<div class="chip ${activeCount?'active':''}" onclick="openFilter('${f.key}')">
                    ${f.label} ${activeCount ? `(${activeCount})` : 'â–¼'}
                </div>`
            }).join('')}
            ${Object.keys(filters).some(k => filters[k].length) ? `<button class="btn btn-danger btn-xs" onclick="clearFilters()">âœ•</button>` : ''}
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        ${APP_DEF.fields.map(f => `<th style="width:${f.width || 'auto'}; text-align:${f.align || 'left'}">${f.label}</th>`).join('')}
                        <th style="width:50px"></th>
                    </tr>
                </thead>
                <tbody>
                    ${filteredData.map(row => `
                        <tr onclick="openModal(${row.id})">
                            ${APP_DEF.fields.map(f => {
                                let val = row[f.key];
                                let content = val || '-';
                                
                                // Format logic
                                if(f.search && searchQuery) content = highlight(String(val), searchQuery);
                                if(f.type === 'bool') content = val ? 'âœ…' : '';
                                
                                // Style logic
                                let style = f.style || '';
                                if(f.align) style += `;text-align:${f.align}`;
                                if(f.color) style += `;color:${APP_DEF.hooks.getColor(val)}`;
                                
                                // Badges
                                if(f.badge) {
                                    const listHtml = getBadgeHtml(f.list, val);
                                    if(listHtml) content = listHtml;
                                }

                                return `<td style="${style}">${content}</td>`;
                            }).join('')}
                            <td onclick="event.stopPropagation()">
                                <button class="btn btn-xs btn-danger" onclick="deleteItem(${row.id})">Ã—</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
                <tfoot>
                    <tr>
                        ${APP_DEF.fields.map(f => {
                            if (f.summary === 'sum') {
                                const sum = filteredData.reduce((acc, r) => acc + (parseFloat(r[f.key])||0), 0);
                                return `<td style="text-align:${f.align||'left'}">${sum.toLocaleString()}</td>`;
                            } else if (f.summary === 'count') {
                                return `<td>${filteredData.length}</td>`;
                            }
                            return `<td></td>`;
                        }).join('')}
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        
        <div style="margin-top:20px; color:var(--muted); text-align:center; font-size:12px;">
            ${filteredData.length} Ã©lÃ©ment(s)
        </div>
    `;
    
    app.innerHTML = html;
}

// --- MODAL ENGINE (Dynamic Form) ---
function openModal(id = null) {
    editingId = id;
    const item = id ? data.find(d => d.id === id) : {};
    
    // Create Inputs based on Config
    const inputsHtml = APP_DEF.fields.map(f => {
        let val = item[f.key] !== undefined ? item[f.key] : (f.default || '');
        let inputEl = '';
        const disabled = f.readOnly ? 'disabled' : '';
        
        if (f.type === 'select') {
            const opts = (lists[f.list] || []).map(o => `<option value="${o.nom}" ${val===o.nom?'selected':''}>${o.nom}</option>`).join('');
            inputEl = `<select id="inp-${f.key}" class="form-control" ${disabled}><option value="">-</option>${opts}</select>`;
            // Add "Add new" for dynamic lists (like Programmes)
            if(!APP_DEF.lists[f.list] || APP_DEF.lists[f.list].length === 0 || f.list === 'programmes') {
               inputEl += `<input class="form-control" style="margin-top:5px; font-size:12px" placeholder="Ou nouveau..." onchange="document.getElementById('inp-${f.key}').innerHTML += '<option selected>'+this.value+'</option>'">`; 
            }
        } 
        else if (f.type === 'textarea') {
            inputEl = `<textarea id="inp-${f.key}" class="form-control" rows="3" ${disabled}>${val}</textarea>`;
        } 
        else if (f.type === 'bool') {
            inputEl = `<div style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--input);border-radius:8px;border:1px solid var(--border)">
                <input type="checkbox" id="inp-${f.key}" ${val?'checked':''} ${disabled} style="width:20px;height:20px;">
                <label for="inp-${f.key}">${f.label}</label>
            </div>`;
        }
        else {
            inputEl = `<input type="${f.type}" id="inp-${f.key}" class="form-control" value="${val}" ${disabled}>`;
        }

        // Add auto-calc trigger
        const onInput = f.calcTrigger ? `oninput="runAutoCalc()"` : '';
        
        return `<div class="form-group" ${onInput}>
            <label class="form-label">${f.label}</label>
            ${inputEl}
        </div>`;
    }).join('');

    const modalHtml = `
        <div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
            <div class="modal">
                <h2 style="margin-bottom:20px">${id ? 'Modifier' : 'Nouveau'}</h2>
                <div class="form-grid" style="display:grid; grid-template-columns: 1fr 1fr; gap:20px">
                    ${inputsHtml}
                </div>
                <div style="margin-top:30px; display:flex; gap:10px; justify-content:flex-end">
                    <button class="btn" onclick="document.getElementById('modal-overlay').remove()">Annuler</button>
                    <button class="btn btn-primary" onclick="saveItem()">Enregistrer</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function runAutoCalc() {
    // Collect temp object from inputs
    let tempItem = {};
    APP_DEF.fields.forEach(f => {
        const el = document.getElementById(`inp-${f.key}`);
        if(!el) return;
        if(f.type === 'bool') tempItem[f.key] = el.checked;
        else tempItem[f.key] = el.value;
    });
    
    // Run Hook
    if(APP_DEF.hooks.onCalculate) {
        tempItem = APP_DEF.hooks.onCalculate(tempItem);
        // Update ReadOnly fields
        APP_DEF.fields.forEach(f => {
            if(f.readOnly) {
                const el = document.getElementById(`inp-${f.key}`);
                if(el) el.value = tempItem[f.key];
            }
        });
    }
}

function saveItem() {
    saveHistory();
    let item = editingId ? data.find(d => d.id === editingId) : { id: Date.now() };
    
    APP_DEF.fields.forEach(f => {
        const el = document.getElementById(`inp-${f.key}`);
        if(f.readOnly) return; // Computed fields are handled by hook
        if(f.type === 'bool') item[f.key] = el.checked;
        else item[f.key] = el.value;
    });

    // Run final calc
    if(APP_DEF.hooks.onCalculate) item = APP_DEF.hooks.onCalculate(item);

    // Sync Dynamic Lists (add new items automatically)
    APP_DEF.fields.forEach(f => {
        if(f.type === 'select' && item[f.key]) {
            // Check if lists[f.list] exists, if not init it
            if(!lists[f.list]) lists[f.list] = [];
            // Add if not present
            if(!lists[f.list].find(x => x.nom === item[f.key])) {
                lists[f.list].push({ id: Date.now(), nom: item[f.key], color: APP_DEF.hooks.getColor(item[f.key]) });
            }
        }
    });

    if (!editingId) data.push(item);
    
    persist();
    document.getElementById('modal-overlay').remove();
    renderApp();
    showToast("EnregistrÃ©");
}

function deleteItem(id) {
    if(confirm('Supprimer ?')) {
        saveHistory();
        data = data.filter(d => d.id !== id);
        persist();
        renderApp();
    }
}

// --- UTILS & HELPERS ---
function saveHistory() { historyStack.push(JSON.stringify(data)); if(historyStack.length > 20) historyStack.shift(); }
function undo() { if(historyStack.length) { data = JSON.parse(historyStack.pop()); persist(); renderApp(); showToast("AnnulÃ©"); } }
function persist() { localStorage.setItem(APP_DEF.storageKey+'_data', JSON.stringify(data)); localStorage.setItem(APP_DEF.storageKey+'_lists', JSON.stringify(lists)); }
function setSearch(val) { searchQuery = val; renderApp(); }
function highlight(text, term) { return text.replace(new RegExp(`(${term})`, 'gi'), '<span class="highlight">$1</span>'); }
function getBadgeHtml(listName, val) {
    const item = (lists[listName]||[]).find(x => x.nom === val);
    if(!item) return null;
    return `<span class="badge" style="background:${item.color}20; color:${item.color}">${val}</span>`;
}
function toggleTheme() { document.documentElement.classList.toggle('light'); }
function exportCSV() {
    const headers = APP_DEF.fields.map(f => f.label).join(';');
    const rows = data.map(d => APP_DEF.fields.map(f => `"${d[f.key]||''}"`).join(';')).join('\n');
    const blob = new Blob(['\ufeff' + headers + '\n' + rows], {type: 'text/csv;charset=utf-8'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'export.csv'; a.click();
}
function showToast(msg) {
    const t = document.createElement('div'); t.className = 'toast'; t.innerText = msg;
    document.body.appendChild(t); setTimeout(() => t.remove(), 3000);
}
// Filter logic (simplified for v7 demo)
function openFilter(key) {
    const val = prompt(`Filtrer par ${key} (Laisser vide pour tout voir)`);
    if(val === null) return;
    if(val === "") filters[key] = [];
    else filters[key] = [val];
    renderApp();
}
function clearFilters() { filters = {}; renderApp(); }

// BOOT
init();
</script>
</body>
</html>
